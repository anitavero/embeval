<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>source.task_eval &mdash; EmbEval 18 October 2021 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> EmbEval
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dependencies.html">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example.html">Example Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">EmbEval Modules Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">EmbEval</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>source.task_eval</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for source.task_eval</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="k">import</span> <span class="n">cosine_distances</span><span class="p">,</span> <span class="n">cosine_similarity</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">spearmanr</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="k">import</span> <span class="n">wordnet</span> <span class="k">as</span> <span class="n">wn</span>
<span class="kn">import</span> <span class="nn">spacy</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">argh</span>
<span class="kn">from</span> <span class="nn">argh</span> <span class="k">import</span> <span class="n">arg</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;savefig.dpi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">300</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="k">import</span> <span class="n">Line2D</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;fivethirtyeight&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">combinations</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="k">import</span> <span class="n">tabulate</span><span class="p">,</span> <span class="n">LATEX_ESCAPE_RULES</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">source.process_embeddings</span> <span class="k">import</span> <span class="n">mid_fusion</span><span class="p">,</span> <span class="n">MM_TOKEN</span><span class="p">,</span> <span class="n">Embeddings</span>
<span class="kn">import</span> <span class="nn">source.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">from</span> <span class="nn">source.utils</span> <span class="k">import</span> <span class="n">get_vec</span><span class="p">,</span> <span class="n">pfont</span><span class="p">,</span> <span class="n">PrintFont</span><span class="p">,</span> <span class="n">LaTeXFont</span><span class="p">,</span> <span class="n">latex_table_post_process</span><span class="p">,</span> <span class="n">latex_table_wrapper</span><span class="p">,</span> \
                         <span class="n">dict2struct_array</span><span class="p">,</span> <span class="n">tuple_list</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../2v2_software_privatefork/&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">two_vs_two</span>

<span class="n">MISSING</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>  <span class="c1"># Signify word pairs which aren&#39;t covered by and embedding&#39;s vocabulary</span>
<span class="n">ROUND</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Round scores in print</span>
<span class="n">NAME_DELIM</span> <span class="o">=</span> <span class="s1">&#39; | &#39;</span>
<span class="n">linewidth</span> <span class="o">=</span> <span class="mi">3</span>


<span class="c1"># We could use dataclass decorator in case of python 3.7</span>
<div class="viewcode-block" id="DataSets"><a class="viewcode-back" href="../../source.html#source.task_eval.DataSets">[docs]</a><span class="k">class</span> <span class="nc">DataSets</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class for storing evaluation datasets and linguistic embeddings.&quot;&quot;&quot;</span>
    <span class="c1"># Evaluation datasets</span>
    <span class="n">men</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>
    <span class="n">simlex</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>
    <span class="c1"># simverb: List[Tuple[str, str, float]]</span>
    <span class="n">fmri_vocab</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;airplane&#39;</span><span class="p">,</span> <span class="s1">&#39;ant&#39;</span><span class="p">,</span> <span class="s1">&#39;apartment&#39;</span><span class="p">,</span> <span class="s1">&#39;arch&#39;</span><span class="p">,</span> <span class="s1">&#39;arm&#39;</span><span class="p">,</span> <span class="s1">&#39;barn&#39;</span><span class="p">,</span> <span class="s1">&#39;bear&#39;</span><span class="p">,</span> <span class="s1">&#39;bed&#39;</span><span class="p">,</span> <span class="s1">&#39;bee&#39;</span><span class="p">,</span> <span class="s1">&#39;beetle&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;bell&#39;</span><span class="p">,</span> <span class="s1">&#39;bicycle&#39;</span><span class="p">,</span> <span class="s1">&#39;bottle&#39;</span><span class="p">,</span> <span class="s1">&#39;butterfly&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">,</span> <span class="s1">&#39;carrot&#39;</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="s1">&#39;celery&#39;</span><span class="p">,</span> <span class="s1">&#39;chair&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;chimney&#39;</span><span class="p">,</span> <span class="s1">&#39;chisel&#39;</span><span class="p">,</span> <span class="s1">&#39;church&#39;</span><span class="p">,</span> <span class="s1">&#39;closet&#39;</span><span class="p">,</span> <span class="s1">&#39;coat&#39;</span><span class="p">,</span> <span class="s1">&#39;corn&#39;</span><span class="p">,</span> <span class="s1">&#39;cow&#39;</span><span class="p">,</span> <span class="s1">&#39;cup&#39;</span><span class="p">,</span> <span class="s1">&#39;desk&#39;</span><span class="p">,</span> <span class="s1">&#39;dog&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;door&#39;</span><span class="p">,</span> <span class="s1">&#39;dress&#39;</span><span class="p">,</span> <span class="s1">&#39;dresser&#39;</span><span class="p">,</span> <span class="s1">&#39;eye&#39;</span><span class="p">,</span> <span class="s1">&#39;fly&#39;</span><span class="p">,</span> <span class="s1">&#39;foot&#39;</span><span class="p">,</span> <span class="s1">&#39;glass&#39;</span><span class="p">,</span> <span class="s1">&#39;hammer&#39;</span><span class="p">,</span> <span class="s1">&#39;hand&#39;</span><span class="p">,</span> <span class="s1">&#39;horse&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;house&#39;</span><span class="p">,</span> <span class="s1">&#39;igloo&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;knife&#39;</span><span class="p">,</span> <span class="s1">&#39;leg&#39;</span><span class="p">,</span> <span class="s1">&#39;lettuce&#39;</span><span class="p">,</span> <span class="s1">&#39;pants&#39;</span><span class="p">,</span> <span class="s1">&#39;pliers&#39;</span><span class="p">,</span> <span class="s1">&#39;refrigerator&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;saw&#39;</span><span class="p">,</span> <span class="s1">&#39;screwdriver&#39;</span><span class="p">,</span> <span class="s1">&#39;shirt&#39;</span><span class="p">,</span> <span class="s1">&#39;skirt&#39;</span><span class="p">,</span> <span class="s1">&#39;spoon&#39;</span><span class="p">,</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;telephone&#39;</span><span class="p">,</span> <span class="s1">&#39;tomato&#39;</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;truck&#39;</span><span class="p">,</span> <span class="s1">&#39;watch&#39;</span><span class="p">,</span> <span class="s1">&#39;window&#39;</span><span class="p">]</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">normalizers</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datadir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># SIMVERB = datadir + &#39;/simverb-3500-data&#39;</span>
        <span class="c1"># simverb_full = list(csv.reader(open(SIMVERB + &#39;/SimVerb-3500.txt&#39;), delimiter=&#39;\t&#39;))</span>
        <span class="c1"># self.simverb = list(map(lambda x: [x[0], x[1], x[3]], simverb_full))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">men</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">datadir</span> <span class="o">+</span> <span class="s1">&#39;/men.json&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simlex</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">datadir</span> <span class="o">+</span> <span class="s1">&#39;/simlex.json&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MEN&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">men</span><span class="p">,</span> <span class="s1">&#39;SimLex&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">simlex</span><span class="p">}</span>  <span class="c1"># , &#39;SimVerb&#39;: self.simverb}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalizers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MEN&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;SimLex&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>  <span class="c1"># , &#39;SimVerb&#39;: 10}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_num</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MEN&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;SimLex&#39;</span><span class="p">:</span> <span class="mi">999</span><span class="p">}</span></div>


<div class="viewcode-block" id="dataset_vocab"><a class="viewcode-back" href="../../source.html#source.task_eval.dataset_vocab">[docs]</a><span class="k">def</span> <span class="nf">dataset_vocab</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">dataset</span><span class="p">))[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pairs</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span></div>


<div class="viewcode-block" id="compute_dists"><a class="viewcode-back" href="../../source.html#source.task_eval.compute_dists">[docs]</a><span class="k">def</span> <span class="nf">compute_dists</span><span class="p">(</span><span class="n">vecs</span><span class="p">):</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">cosine_distances</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span> <span class="n">vecs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dists</span></div>


<div class="viewcode-block" id="neighbors"><a class="viewcode-back" href="../../source.html#source.task_eval.neighbors">[docs]</a><span class="k">def</span> <span class="nf">neighbors</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">vecs</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">compute_dists</span><span class="p">(</span><span class="n">vecs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vocab</span> <span class="o">==</span> <span class="n">w</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">words</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">vocab</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vocab</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">])[:</span><span class="n">n</span><span class="p">]])</span></div>


<div class="viewcode-block" id="covered"><a class="viewcode-back" href="../../source.html#source.task_eval.covered">[docs]</a><span class="k">def</span> <span class="nf">covered</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">vocab</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">vocab</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">dataset</span><span class="p">))</span></div>


<div class="viewcode-block" id="coverage"><a class="viewcode-back" href="../../source.html#source.task_eval.coverage">[docs]</a><span class="k">def</span> <span class="nf">coverage</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;en&#39;</span><span class="p">)</span>
    <span class="n">vvocab_lemma</span> <span class="o">=</span> <span class="p">[[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nlp</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="p">))][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lemma_</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">vocabulary</span><span class="p">]</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span> <span class="o">+</span> <span class="n">vvocab_lemma</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Vocab size:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Vocab size with lemmas:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">))</span>

    <span class="c1"># Semantic similarity/relatedness datasets</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;MEN&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">men</span><span class="p">,</span> <span class="s1">&#39;SimLex&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">simlex</span><span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">coverage</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">covered</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">vocabulary</span><span class="p">))</span>
        <span class="n">coverage_lemma</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">covered</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">vocab</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{name}</span><span class="s1"> pair coverage:&#39;</span><span class="p">,</span>
              <span class="n">coverage_lemma</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;({round(100 * coverage_lemma / len(dataset))}%)&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{name}</span><span class="s1"> pair coverage without lemmas:&#39;</span><span class="p">,</span>
              <span class="n">coverage</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;({round(100 * coverage / len(dataset))}%)&#39;</span><span class="p">)</span>

    <span class="c1"># Mitchell (2008) fMRI data: 60 nouns</span>
    <span class="n">coverage</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">fmri_vocab</span><span class="p">))))</span>
    <span class="n">coverage_lemma</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">fmri_vocab</span><span class="p">))))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;fMRI coverage:&#39;</span><span class="p">,</span> <span class="n">coverage_lemma</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;({round(100 * coverage_lemma / len(data.fmri_vocab))}%)&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;fMRI coverage without lemmas:&#39;</span><span class="p">,</span> <span class="n">coverage</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;({round(100 * coverage / len(data.fmri_vocab))}%)&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="divide_eval_vocab_by_freqranges"><a class="viewcode-back" href="../../source.html#source.task_eval.divide_eval_vocab_by_freqranges">[docs]</a><span class="k">def</span> <span class="nf">divide_eval_vocab_by_freqranges</span><span class="p">(</span><span class="n">distribution_file</span><span class="p">,</span> <span class="n">eval_data_dir</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">num_groups</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">distribution_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataSets</span><span class="p">(</span><span class="n">eval_data_dir</span><span class="p">)</span>
    <span class="n">evalv</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dataset_vocab</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">])))</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Filter distribution file with </span><span class="si">{dataset_name}</span><span class="s1"> vocab&#39;</span><span class="p">)</span>
    <span class="n">eval_dist</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">evalv</span><span class="p">)</span> <span class="c1"># Filter distribution vocab by eval vocab</span>

    <span class="c1"># Print and save logs</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;#</span><span class="si">{dataset_name}</span><span class="s1"> vocab: {len(evalv)}</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">log</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39;#Filtered Wiki vocab: {len(eval_dist)}</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eval_dist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">evalv</span><span class="p">):</span>
       <span class="n">log</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39;Missing words in Wiki: {list(set(evalv) - set(eval_dist.keys()))}&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{os.path.splitext(distribution_file)[0]}_</span><span class="si">{dataset_name}</span><span class="s1">_split</span><span class="si">{num_groups}</span><span class="s1">.log&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>

    <span class="n">sorted_dist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">eval_dist</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>     <span class="c1"># sort words by frequency</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">evalv</span><span class="p">)</span>
    <span class="n">swords</span><span class="p">,</span> <span class="n">scounts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">sorted_dist</span><span class="p">)</span>
    <span class="n">group_size</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="n">num_groups</span><span class="p">)</span>
    <span class="n">fqvocabs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">group_size</span><span class="p">):</span>
        <span class="n">fmin</span> <span class="o">=</span> <span class="n">scounts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="o">+</span> <span class="n">group_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fmax</span> <span class="o">=</span> <span class="n">scounts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">group_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmax</span> <span class="o">=</span> <span class="n">scounts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fqvocabs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{fmin}</span><span class="s1"> </span><span class="si">{fmax}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">swords</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">group_size</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>    <span class="c1"># Save vocabs for freq ranges</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{os.path.splitext(distribution_file)[0]}_</span><span class="si">{dataset_name}</span><span class="s1">_split</span><span class="si">{num_groups}</span><span class="s1">.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">fqvocabs</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fqvocabs</span></div>


<div class="viewcode-block" id="compute_correlations"><a class="viewcode-back" href="../../source.html#source.task_eval.compute_correlations">[docs]</a><span class="k">def</span> <span class="nf">compute_correlations</span><span class="p">(</span><span class="n">scores</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="n">name_pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">common_subset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">leave_out</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute correlation between score series.</span>
<span class="sd">        :param scores: Structured array of scores with embedding/ground_truth names.</span>
<span class="sd">        :param name_pairs: pairs of scores to correlate. If None, every pair will be computed.</span>
<span class="sd">                          if &#39;gt&#39;, everything will be plot against the ground_truth.</span>
<span class="sd">       :param leave_out: Leave out 1/leave_out portion of pairs, chosen randomly. Does not leave out if it is False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name_pairs</span> <span class="o">==</span> <span class="s1">&#39;gt&#39;</span><span class="p">:</span>
        <span class="n">name_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;ground_truth&#39;</span><span class="p">,</span> <span class="n">nm</span><span class="p">)</span> <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
                      <span class="k">if</span> <span class="n">nm</span> <span class="o">!=</span> <span class="s1">&#39;ground_truth&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">name_pairs</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">name_pairs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name_pairs</span><span class="p">:</span>  <span class="c1"># Correlations for all combinations of 2</span>
        <span class="n">name_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">common_subset</span><span class="p">:</span>  <span class="c1"># Filter rows where any of the scores are missing for a word pair</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MISSING</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">scs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">scs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="nb">list</span><span class="p">(</span><span class="n">ids</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scs</span> <span class="o">=</span> <span class="n">scores</span>

    <span class="n">correlations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">nm1</span><span class="p">,</span> <span class="n">nm2</span> <span class="ow">in</span> <span class="n">name_pairs</span><span class="p">:</span>
        <span class="c1"># Filter pairs which the scores, coming from any of the two embeddings, don&#39;t cover</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scs</span><span class="p">[</span><span class="n">nm1</span><span class="p">]</span> <span class="o">==</span> <span class="n">MISSING</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{nm1}</span><span class="s1"> has 0 coverage.&#39;</span><span class="p">)</span>
            <span class="n">correlations</span><span class="p">[</span><span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">nm1</span><span class="p">,</span> <span class="n">nm2</span><span class="p">])]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">scs</span><span class="p">[</span><span class="n">nm2</span><span class="p">]</span> <span class="o">==</span> <span class="n">MISSING</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{nm2}</span><span class="s1"> has 0 coverage.&#39;</span><span class="p">)</span>
            <span class="n">correlations</span><span class="p">[</span><span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">nm1</span><span class="p">,</span> <span class="n">nm2</span><span class="p">])]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scores1</span><span class="p">,</span> <span class="n">scores2</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="k">for</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="ow">in</span>
                                     <span class="nb">zip</span><span class="p">(</span><span class="n">scs</span><span class="p">[</span><span class="n">nm1</span><span class="p">],</span> <span class="n">scs</span><span class="p">[</span><span class="n">nm2</span><span class="p">])</span> <span class="k">if</span> <span class="n">s1</span> <span class="o">!=</span> <span class="n">MISSING</span> <span class="ow">and</span> <span class="n">s2</span> <span class="o">!=</span> <span class="n">MISSING</span><span class="p">])</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">leave_out</span><span class="p">:</span>
                <span class="n">lp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores1</span><span class="p">)</span>
                <span class="n">keep</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">leave_out</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">lp</span> <span class="o">*</span> <span class="n">keep</span><span class="p">)]</span>
                <span class="n">scores1</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scores1</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
                <span class="n">scores2</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scores2</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span><span class="n">scores1</span><span class="p">,</span> <span class="n">scores2</span><span class="p">)</span>
            <span class="n">correlations</span><span class="p">[</span><span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">nm1</span><span class="p">,</span> <span class="n">nm2</span><span class="p">])]</span> <span class="o">=</span> <span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">correlation</span><span class="p">,</span> <span class="n">corr</span><span class="o">.</span><span class="n">pvalue</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">correlations</span></div>


<div class="viewcode-block" id="highlight"><a class="viewcode-back" href="../../source.html#source.task_eval.highlight">[docs]</a><span class="k">def</span> <span class="nf">highlight</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">conditions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">tablefmt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Highlight value in a table column.</span>
<span class="sd">    :param val: number, value</span>
<span class="sd">    :param conditions: dict of {colour: condition}</span>
<span class="sd">    :param tablefmt: &#39;simple&#39; is terminal, &#39;latex-raw&#39; is LaTeX</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">val</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ROUND</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conditions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">tablefmt</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cond</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pfont</span><span class="p">([</span><span class="n">color</span><span class="p">,</span> <span class="s1">&#39;BOLD&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ROUND</span><span class="p">),</span> <span class="n">f</span><span class="s2">&quot;.</span><span class="si">{ROUND}</span><span class="s2">f&quot;</span><span class="p">),</span> <span class="n">PrintFont</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tablefmt</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;latex&#39;</span><span class="p">,</span> <span class="s1">&#39;latex_raw&#39;</span><span class="p">]:</span>  <span class="c1"># needs to be amended by hand</span>
            <span class="k">if</span> <span class="n">cond</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pfont</span><span class="p">([</span><span class="n">color</span><span class="p">,</span> <span class="s1">&#39;BOLD&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="nb">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ROUND</span><span class="p">),</span> <span class="n">f</span><span class="s2">&quot;.</span><span class="si">{ROUND}</span><span class="s2">f&quot;</span><span class="p">)),</span> <span class="n">LaTeXFont</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">format</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;.</span><span class="si">{ROUND}</span><span class="s2">f&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="mm_over_uni"><a class="viewcode-back" href="../../source.html#source.task_eval.mm_over_uni">[docs]</a><span class="k">def</span> <span class="nf">mm_over_uni</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">score_dict</span><span class="p">):</span>
    <span class="n">nam</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">NAME_DELIM</span> <span class="ow">in</span> <span class="n">nam</span><span class="p">:</span>  <span class="c1"># SemSim scores</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">vname</span> <span class="o">=</span> <span class="n">nam</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">NAME_DELIM</span><span class="p">)</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">NAME_DELIM</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Brain scores</span>
        <span class="n">vname</span> <span class="o">=</span> <span class="n">nam</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">MM_TOKEN</span> <span class="ow">in</span> <span class="n">vname</span><span class="p">:</span>
        <span class="n">nm1</span><span class="p">,</span> <span class="n">nm2</span> <span class="o">=</span> <span class="n">vname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">MM_TOKEN</span><span class="p">)</span>
        <span class="n">get_score</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ROUND</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">else</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ROUND</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">get_score</span><span class="p">(</span><span class="n">score_dict</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">get_score</span><span class="p">(</span><span class="n">score_dict</span><span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">nm1</span><span class="p">])</span> <span class="ow">and</span> \
               <span class="n">get_score</span><span class="p">(</span><span class="n">score_dict</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">get_score</span><span class="p">(</span><span class="n">score_dict</span><span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">nm2</span><span class="p">])</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="latex_escape"><a class="viewcode-back" href="../../source.html#source.task_eval.latex_escape">[docs]</a><span class="k">def</span> <span class="nf">latex_escape</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">LATEX_ESCAPE_RULES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="p">])</span></div>


<div class="viewcode-block" id="print_correlations"><a class="viewcode-back" href="../../source.html#source.task_eval.print_correlations">[docs]</a><span class="k">def</span> <span class="nf">print_correlations</span><span class="p">(</span><span class="n">scores</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">name_pairs</span><span class="o">=</span><span class="s1">&#39;gt&#39;</span><span class="p">,</span>
                       <span class="n">common_subset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">tablefmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;simple&quot;</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="n">correlations</span> <span class="o">=</span> <span class="n">compute_correlations</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">name_pairs</span><span class="p">,</span> <span class="n">common_subset</span><span class="o">=</span><span class="n">common_subset</span><span class="p">)</span>
    <span class="n">maxcorr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">correlations</span><span class="o">.</span><span class="n">values</span><span class="p">()))[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">mm_o_uni</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mm_over_uni</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">correlations</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;latex&#39;</span> <span class="ow">in</span> <span class="n">tablefmt</span><span class="p">:</span>
        <span class="n">escape</span> <span class="o">=</span> <span class="n">latex_escape</span>
        <span class="n">font</span> <span class="o">=</span> <span class="n">LaTeXFont</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">escape</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
        <span class="n">font</span> <span class="o">=</span> <span class="n">PrintFont</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">([(</span><span class="n">pfont</span><span class="p">([</span><span class="s1">&#39;ITALIC&#39;</span><span class="p">],</span> <span class="n">escape</span><span class="p">(</span><span class="n">Embeddings</span><span class="o">.</span><span class="n">get_label</span><span class="p">(</span><span class="n">nm</span><span class="p">)),</span> <span class="n">font</span><span class="p">),</span>
                       <span class="n">highlight</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;red&#39;</span><span class="p">:</span> <span class="n">corr</span> <span class="o">==</span> <span class="n">maxcorr</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">:</span> <span class="n">mm_o_uni</span><span class="p">(</span><span class="n">nm</span><span class="p">)},</span> <span class="n">tablefmt</span><span class="p">),</span>
                       <span class="nb">format</span><span class="p">(</span><span class="n">pvalue</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;.</span><span class="si">{ROUND}</span><span class="s2">f&quot;</span><span class="p">),</span>
                       <span class="n">length</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">nm</span><span class="p">,</span> <span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="ow">in</span> <span class="n">correlations</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
                     <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="n">pfont</span><span class="p">([</span><span class="s1">&#39;BOLD&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                              <span class="p">[</span><span class="s1">&#39;Name pairs&#39;</span><span class="p">,</span> <span class="s1">&#39;Spearman&#39;</span><span class="p">,</span> <span class="s1">&#39;P-value&#39;</span><span class="p">,</span> <span class="s1">&#39;Coverage&#39;</span><span class="p">]],</span>
                     <span class="n">tablefmt</span><span class="o">=</span><span class="n">tablefmt</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;latex&#39;</span> <span class="ow">in</span> <span class="n">tablefmt</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">latex_table_post_process</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="n">caption</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span></div>


<div class="viewcode-block" id="print_subsampled_correlations"><a class="viewcode-back" href="../../source.html#source.task_eval.print_subsampled_correlations">[docs]</a><span class="k">def</span> <span class="nf">print_subsampled_correlations</span><span class="p">(</span><span class="n">scores</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">name_pairs</span><span class="o">=</span><span class="s1">&#39;gt&#39;</span><span class="p">,</span>
                       <span class="n">common_subset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">tablefmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;simple&quot;</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">n_sample</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">correlation_smpl</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sample</span><span class="p">):</span>
        <span class="n">correlations</span> <span class="o">=</span> <span class="n">compute_correlations</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">name_pairs</span><span class="p">,</span> <span class="n">common_subset</span><span class="o">=</span><span class="n">common_subset</span><span class="p">,</span> <span class="n">leave_out</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">pval</span><span class="p">,</span> <span class="nb">len</span><span class="p">)</span> <span class="ow">in</span> <span class="n">correlations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">correlation_smpl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="n">corr</span><span class="p">],</span> <span class="p">[</span><span class="n">pval</span><span class="p">],</span> <span class="p">[</span><span class="nb">len</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">corrs</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">lens</span><span class="p">)</span> <span class="ow">in</span> <span class="n">correlation_smpl</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">corr</span><span class="p">,</span> <span class="n">pval</span><span class="p">,</span> <span class="nb">len</span> <span class="o">=</span> <span class="n">correlations</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">correlation_smpl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">corrs</span> <span class="o">+</span> <span class="p">[</span><span class="n">corr</span><span class="p">],</span> <span class="n">pvals</span> <span class="o">+</span> <span class="p">[</span><span class="n">pval</span><span class="p">],</span> <span class="n">lens</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">])</span>
    <span class="n">maxcorr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">correlations</span><span class="o">.</span><span class="n">values</span><span class="p">()))[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># def mm_o_uni(name):</span>
    <span class="c1">#     return mm_over_uni(name, correlations)</span>

    <span class="k">if</span> <span class="s1">&#39;latex&#39;</span> <span class="ow">in</span> <span class="n">tablefmt</span><span class="p">:</span>
        <span class="n">escape</span> <span class="o">=</span> <span class="n">latex_escape</span>
        <span class="n">font</span> <span class="o">=</span> <span class="n">LaTeXFont</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">escape</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
        <span class="n">font</span> <span class="o">=</span> <span class="n">PrintFont</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">([(</span><span class="n">pfont</span><span class="p">([</span><span class="s1">&#39;ITALIC&#39;</span><span class="p">],</span> <span class="n">escape</span><span class="p">(</span><span class="n">Embeddings</span><span class="o">.</span><span class="n">get_label</span><span class="p">(</span><span class="n">nm</span><span class="p">)),</span> <span class="n">font</span><span class="p">),</span>
                       <span class="n">f</span><span class="s1">&#39;{format(round(np.mean(corrs), ROUND), f&quot;.</span><span class="si">{ROUND}</span><span class="s1">f&quot;)} ({format(round(np.std(corrs), ROUND), f&quot;.</span><span class="si">{ROUND}</span><span class="s1">f&quot;)})&#39;</span><span class="p">,</span>
                       <span class="n">f</span><span class="s1">&#39;{format(round(np.mean(pvals), ROUND), f&quot;.</span><span class="si">{ROUND}</span><span class="s1">f&quot;)} ({format(round(np.std(pvals), ROUND), f&quot;.</span><span class="si">{ROUND}</span><span class="s1">f&quot;)})&#39;</span><span class="p">,</span>
                       <span class="n">lens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                      <span class="k">for</span> <span class="n">nm</span><span class="p">,</span> <span class="p">(</span><span class="n">corrs</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">lens</span><span class="p">)</span> <span class="ow">in</span> <span class="n">correlation_smpl</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
                     <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="n">pfont</span><span class="p">([</span><span class="s1">&#39;BOLD&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                              <span class="p">[</span><span class="s1">&#39;Name pairs&#39;</span><span class="p">,</span> <span class="s1">&#39;Spearman&#39;</span><span class="p">,</span> <span class="s1">&#39;P-value&#39;</span><span class="p">,</span> <span class="s1">&#39;Coverage&#39;</span><span class="p">]],</span>
                     <span class="n">tablefmt</span><span class="o">=</span><span class="n">tablefmt</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;latex&#39;</span> <span class="ow">in</span> <span class="n">tablefmt</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">latex_table_post_process</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="n">caption</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span></div>


<div class="viewcode-block" id="print_brain_scores"><a class="viewcode-back" href="../../source.html#source.task_eval.print_brain_scores">[docs]</a><span class="k">def</span> <span class="nf">print_brain_scores</span><span class="p">(</span><span class="n">brain_scores</span><span class="p">,</span> <span class="n">tablefmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;simple&quot;</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="c1"># Map for printable labels</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">Embeddings</span><span class="o">.</span><span class="n">get_label</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">brain_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">lingvnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Embeddings</span><span class="o">.</span><span class="n">fasttext_vss</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
    <span class="n">VGvnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="s1">&#39;VG SceneGraph&#39;</span><span class="p">]</span>
    <span class="n">mm_vis_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;MM&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">or</span> <span class="n">MM_TOKEN</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39;VG SceneGraph&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]</span>
    <span class="n">mm_VG_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">MM_TOKEN</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39;VG SceneGraph&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]</span>
    <span class="n">visvnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lingvnames</span> <span class="o">+</span> <span class="n">VGvnames</span> <span class="o">+</span> <span class="n">mm_VG_names</span> <span class="o">+</span> <span class="n">mm_vis_names</span><span class="p">))</span>
    <span class="n">brain_scores_ordered</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Group E_L, E_V, E_S, E_L + E_V, E_L + E_S vecs</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">lingvnames</span><span class="p">:</span>
        <span class="n">brain_scores_ordered</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">brain_scores</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">n</span><span class="p">]]))</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">visvnames</span><span class="p">:</span>
        <span class="n">brain_scores_ordered</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">brain_scores</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">n</span><span class="p">]]))</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">VGvnames</span><span class="p">:</span>
        <span class="n">brain_scores_ordered</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">brain_scores</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">n</span><span class="p">]]))</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">mm_vis_names</span><span class="p">:</span>
        <span class="n">brain_scores_ordered</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">brain_scores</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">n</span><span class="p">]]))</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">mm_VG_names</span><span class="p">:</span>
        <span class="n">brain_scores_ordered</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">brain_scores</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">n</span><span class="p">]]))</span>

    <span class="n">vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">brain_scores</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>

    <span class="k">def</span> <span class="nf">print_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="c1"># Print for individual participants and average &#39;fMRI&#39; or &#39;MEG&#39; scores</span>
        <span class="n">v_avg</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fMRI&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;MEG&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}[</span><span class="n">data</span><span class="p">]</span>
        <span class="n">v_scores</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fMRI&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;MEG&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}[</span><span class="n">data</span><span class="p">]</span>
        <span class="n">max_avg</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">v_avg</span><span class="p">])</span>
        <span class="n">maxes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">vals</span><span class="p">[</span><span class="n">v_scores</span><span class="p">])]</span>
        <span class="n">part_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">brain_scores</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="n">v_scores</span><span class="p">][</span><span class="n">data</span><span class="p">])</span>  <span class="c1"># number of participants</span>
        <span class="c1"># Scores per participant</span>
        <span class="n">score_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">data</span><span class="p">][</span><span class="n">p</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">brain_scores_ordered</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">part_num</span><span class="p">)]</span>
        <span class="n">avg_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{data}</span><span class="s1"> Avg&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">brain_scores_ordered</span><span class="p">)</span>

        <span class="c1"># print(f&#39;\n-------- {data} --------\n&#39;)</span>
        <span class="k">if</span> <span class="s1">&#39;latex&#39;</span> <span class="ow">in</span> <span class="n">tablefmt</span><span class="p">:</span>
            <span class="n">escape</span> <span class="o">=</span> <span class="n">latex_escape</span>
            <span class="n">font</span> <span class="o">=</span> <span class="n">LaTeXFont</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">escape</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
            <span class="n">font</span> <span class="o">=</span> <span class="n">PrintFont</span>

        <span class="n">table</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">([[</span><span class="n">pfont</span><span class="p">([</span><span class="s1">&#39;ITALIC&#39;</span><span class="p">],</span> <span class="n">escape</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">font</span><span class="p">)]</span> <span class="o">+</span>
                          <span class="p">[</span><span class="n">highlight</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;red&#39;</span><span class="p">:</span> <span class="n">c</span> <span class="o">==</span> <span class="n">max_scr</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">:</span> <span class="n">mm_over_uni</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">scr_dict</span><span class="p">)},</span> <span class="n">tablefmt</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">max_scr</span><span class="p">,</span> <span class="n">scr_dict</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">data</span><span class="p">],</span> <span class="n">maxes</span><span class="p">,</span> <span class="n">score_dicts</span><span class="p">)]</span> <span class="o">+</span>
                          <span class="p">[</span><span class="n">highlight</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{data}</span><span class="s1"> Avg&#39;</span><span class="p">],</span>
                                     <span class="p">{</span><span class="s1">&#39;red&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{data}</span><span class="s1"> Avg&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_avg</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">:</span> <span class="n">mm_over_uni</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">avg_dict</span><span class="p">)},</span>
                                     <span class="n">tablefmt</span><span class="p">)]</span> <span class="o">+</span>
                          <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">data</span><span class="p">]),</span> <span class="n">ROUND</span><span class="p">),</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]]</span>
                          <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">brain_scores_ordered</span><span class="p">],</span>
                         <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="n">pfont</span><span class="p">([</span><span class="s1">&#39;BOLD&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                                  <span class="p">[</span><span class="s1">&#39;Embedding&#39;</span><span class="p">]</span> <span class="o">+</span>
                                  <span class="p">[</span><span class="n">f</span><span class="s1">&#39;P{i + 1}&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">part_num</span><span class="p">)]</span> <span class="o">+</span>
                                  <span class="p">[</span><span class="s1">&#39;Avg&#39;</span><span class="p">,</span> <span class="s1">&#39;STD&#39;</span><span class="p">,</span> <span class="s1">&#39;Coverage&#39;</span><span class="p">]],</span>
                         <span class="n">tablefmt</span><span class="o">=</span><span class="n">tablefmt</span><span class="p">)</span>

        <span class="c1"># Table of scores averaged for participants over all models per modality</span>
        <span class="n">ling_avg_P</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dictP</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lingvnames</span><span class="p">])</span> <span class="k">for</span> <span class="n">dictP</span> <span class="ow">in</span> <span class="n">score_dicts</span><span class="p">]</span>
        <span class="n">vis_avg_P</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dictP</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">visvnames</span><span class="p">])</span> <span class="k">for</span> <span class="n">dictP</span> <span class="ow">in</span> <span class="n">score_dicts</span><span class="p">]</span>
        <span class="n">VG_avg_P</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dictP</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">VGvnames</span><span class="p">])</span> <span class="k">for</span> <span class="n">dictP</span> <span class="ow">in</span> <span class="n">score_dicts</span><span class="p">]</span>
        <span class="n">mm_vis_avg_P</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dictP</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mm_vis_names</span><span class="p">])</span> <span class="k">for</span> <span class="n">dictP</span> <span class="ow">in</span> <span class="n">score_dicts</span><span class="p">]</span>
        <span class="n">mm_VG_avg_P</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dictP</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mm_VG_names</span><span class="p">])</span> <span class="k">for</span> <span class="n">dictP</span> <span class="ow">in</span> <span class="n">score_dicts</span><span class="p">]</span>
        <span class="n">maxes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ling_avg_P</span><span class="p">,</span> <span class="n">vis_avg_P</span><span class="p">,</span> <span class="n">VG_avg_P</span><span class="p">,</span> <span class="n">mm_vis_avg_P</span><span class="p">,</span> <span class="n">mm_VG_avg_P</span><span class="p">)]</span>

        <span class="n">table_P</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">([[</span><span class="n">pfont</span><span class="p">([</span><span class="s1">&#39;ITALIC&#39;</span><span class="p">],</span> <span class="n">mod</span><span class="p">,</span> <span class="n">font</span><span class="p">)]</span> <span class="o">+</span>
                            <span class="p">[</span><span class="n">highlight</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;BOLD&#39;</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="n">mx</span><span class="p">},</span> <span class="n">tablefmt</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">mx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">avgPs</span><span class="p">,</span> <span class="n">maxes</span><span class="p">)]</span>
                            <span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">avgPs</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;$E_L$&#39;</span><span class="p">,</span> <span class="n">ling_avg_P</span><span class="p">),</span>
                                               <span class="p">(</span><span class="s1">&#39;$E_V$&#39;</span><span class="p">,</span> <span class="n">vis_avg_P</span><span class="p">),</span>
                                               <span class="p">(</span><span class="s1">&#39;$E_S$&#39;</span><span class="p">,</span> <span class="n">VG_avg_P</span><span class="p">),</span>
                                               <span class="p">(</span><span class="s1">&#39;$E_L + E_V$&#39;</span><span class="p">,</span> <span class="n">mm_vis_avg_P</span><span class="p">),</span>
                                               <span class="p">(</span><span class="s1">&#39;$E_L + E_S$&#39;</span><span class="p">,</span> <span class="n">mm_VG_avg_P</span><span class="p">)]],</span>
                           <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="n">pfont</span><span class="p">([</span><span class="s1">&#39;BOLD&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                                    <span class="p">[</span><span class="s1">&#39;Modality&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;P{i + 1}&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">part_num</span><span class="p">)]],</span>
                           <span class="n">tablefmt</span><span class="o">=</span><span class="n">tablefmt</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;latex&#39;</span> <span class="ow">in</span> <span class="n">tablefmt</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">latex_table_post_process</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
                                             <span class="n">f</span><span class="s1">&#39;</span><span class="si">{data}</span><span class="s1"> scores for each participant and embedding&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="n">caption</span><span class="p">,</span>
                                             <span class="n">fit_to_page</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">data</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">table_P</span> <span class="o">=</span> <span class="n">latex_table_post_process</span><span class="p">(</span><span class="n">table_P</span><span class="p">,</span> <span class="p">[],</span>
                                               <span class="n">f</span><span class="s1">&#39;</span><span class="si">{data}</span><span class="s1"> scores averaged over each modality&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> \
                                               <span class="s1">&#39; Bold signifies the highest average performance for each participant.&#39;</span><span class="p">,</span>
                                               <span class="n">fit_to_page</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;participants&#39;</span><span class="p">]))</span>  <span class="c1"># latex_table_wrapper(table_P)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">table_P</span><span class="p">)</span>

    <span class="n">print_data</span><span class="p">(</span><span class="s1">&#39;fMRI&#39;</span><span class="p">)</span>
    <span class="n">print_data</span><span class="p">(</span><span class="s1">&#39;MEG&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PlotColour"><a class="viewcode-back" href="../../source.html#source.task_eval.PlotColour">[docs]</a><span class="k">class</span> <span class="nc">PlotColour</span><span class="p">:</span>

<div class="viewcode-block" id="PlotColour.colour_by_modality"><a class="viewcode-back" href="../../source.html#source.task_eval.PlotColour.colour_by_modality">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">colour_by_modality</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="n">colours</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">linestyles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">alphas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
            <span class="n">al</span> <span class="o">=</span> <span class="mf">0.8</span>
            <span class="k">if</span> <span class="n">MM_TOKEN</span> <span class="ow">in</span> <span class="n">l</span> <span class="ow">or</span> <span class="s1">&#39;MM&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;VG SceneGraph&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                    <span class="n">colours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#ff3e96&#39;</span><span class="p">)</span>
                    <span class="n">al</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">colours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#e6b830&#39;</span><span class="p">)</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
                    <span class="n">al</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="k">elif</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;wikinews&#39;</span><span class="p">,</span> <span class="s1">&#39;wikinews_sub&#39;</span><span class="p">,</span> <span class="s1">&#39;crawl&#39;</span><span class="p">,</span> <span class="s1">&#39;crawl_sub&#39;</span><span class="p">,</span> <span class="s1">&#39;w2v13&#39;</span><span class="p">]:</span>
                <span class="n">colours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;VG-&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">colours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;VG SceneGraph&#39;</span> <span class="o">==</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">colours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cyan&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
            <span class="n">linestyles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
            <span class="n">alphas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">al</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">colours</span><span class="p">,</span> <span class="n">linestyles</span><span class="p">,</span> <span class="n">alphas</span></div>

<div class="viewcode-block" id="PlotColour.get_legend"><a class="viewcode-back" href="../../source.html#source.task_eval.PlotColour.get_legend">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_legend</span><span class="p">():</span>
        <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">legends</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">linewidth</span><span class="p">),</span>
                   <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#ff3e96&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">linewidth</span><span class="p">),</span>
                   <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#e6b830&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">linewidth</span><span class="p">),</span>
                   <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">linewidth</span><span class="p">),</span>
                   <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">linewidth</span><span class="p">),</span>
                   <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">linewidth</span><span class="p">),</span>
                   <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)]</span>
        <span class="n">leglabels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;WordNet concreteness&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;$E_L + E_S$&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;$E_L + E_V$&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;$E_L$&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;$E_</span><span class="si">{VG}</span><span class="s1">$&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;$E_S$&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;$E_</span><span class="si">{Google}</span><span class="s1">$&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">legends</span><span class="p">,</span> <span class="n">leglabels</span></div></div>


<div class="viewcode-block" id="plot_brain_words"><a class="viewcode-back" href="../../source.html#source.task_eval.plot_brain_words">[docs]</a><span class="k">def</span> <span class="nf">plot_brain_words</span><span class="p">(</span><span class="n">brain_scores</span><span class="p">,</span> <span class="n">plot_order</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot hit counts for word in Brain data.</span>
<span class="sd">    :param brain_scores: brain score dict</span>
<span class="sd">    :param plot_order: &#39;concreteness&#39; orders words for Wordnet conreteness</span>
<span class="sd">                       &lt;emb_name&gt; orders plot for an embedding&#39;s scores</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">brain_scores</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">Embeddings</span><span class="o">.</span><span class="n">get_labels</span><span class="p">(</span><span class="n">brain_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">plot_data</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ord_vocab</span><span class="p">,</span> <span class="n">ord_name</span><span class="p">):</span>
        <span class="n">dscores</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fMRI&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;MEG&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">}[</span><span class="n">data</span><span class="p">]</span>
        <span class="n">word_vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">dscores</span><span class="p">]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">wordlists</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">word_vals</span><span class="p">):</span>  <span class="c1"># embeddings</span>
            <span class="n">word_dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Init dictionary with Brain vocab so we have vectors with same length to plot</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">ord_vocab</span><span class="p">:</span>
                <span class="n">word_dict</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>  <span class="c1"># participants</span>
                <span class="k">for</span> <span class="n">word_pair</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>  <span class="c1"># word pairs</span>
                    <span class="n">word_dict</span><span class="p">[</span><span class="n">word_pair</span><span class="p">[</span><span class="s1">&#39;word1&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">word_pair</span><span class="p">[</span><span class="s1">&#39;hit&#39;</span><span class="p">]</span>
                    <span class="n">word_dict</span><span class="p">[</span><span class="n">word_pair</span><span class="p">[</span><span class="s1">&#39;word2&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">word_pair</span><span class="p">[</span><span class="s1">&#39;hit&#39;</span><span class="p">]</span>
            <span class="c1"># word_dict = dict(((w, word_dict[w]) for w in ord_vocab))  # Sort by concreteness</span>
            <span class="n">scores</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">word_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">wordlists</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">word_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Convert to structured array</span>
        <span class="n">score_arrays</span> <span class="o">=</span> <span class="n">dict2struct_array</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

        <span class="n">tsuffix</span> <span class="o">=</span> <span class="n">ord_name</span> <span class="o">+</span> <span class="s1">&#39; synset score&#39;</span>
        <span class="c1"># Sort by ord_name Embedding</span>
        <span class="k">if</span> <span class="n">ord_name</span> <span class="o">!=</span> <span class="s1">&#39;Median&#39;</span> <span class="ow">and</span> <span class="n">ord_name</span> <span class="o">!=</span> <span class="s1">&#39;Most concrete&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ord_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">ord_name</span> <span class="o">=</span> <span class="n">Embeddings</span><span class="o">.</span><span class="n">get_label</span><span class="p">(</span><span class="n">ord_name</span><span class="p">)</span>
            <span class="n">tsuffix</span> <span class="o">=</span> <span class="s1">&#39;ordered by &#39;</span> <span class="o">+</span> <span class="n">ord_name</span>
            <span class="n">score_arrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">score_arrays</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">ord_name</span><span class="p">)</span>
            <span class="n">ord_vocab</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">wordlists</span><span class="p">[</span><span class="n">ord_name</span><span class="p">],</span> <span class="n">scores</span><span class="p">[</span><span class="n">ord_name</span><span class="p">]),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

        <span class="n">colours</span><span class="p">,</span> <span class="n">linestyles</span><span class="p">,</span> <span class="n">alphas</span> <span class="o">=</span> <span class="n">PlotColour</span><span class="o">.</span><span class="n">colour_by_modality</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="c1"># allhits = sum([hits for hits in scores.values()], [])</span>
        <span class="c1"># ax.set_yticklabels([i for i in range(min(allhits), max(allhits), 6)], rotation=90)</span>
        <span class="n">plot_scores</span><span class="p">(</span><span class="n">score_arrays</span><span class="p">,</span>
                    <span class="n">vecs_names</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                    <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">colours</span><span class="o">=</span><span class="n">colours</span><span class="p">,</span>
                    <span class="n">linestyles</span><span class="o">=</span><span class="n">linestyles</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{data}</span><span class="s1"> - </span><span class="si">{tsuffix}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">alphas</span><span class="o">=</span><span class="n">alphas</span><span class="p">,</span>
                    <span class="n">xtick_labels</span><span class="o">=</span><span class="n">ord_vocab</span><span class="p">,</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">,</span>
                    <span class="n">swapaxes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Hit number&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ord_vocab</span><span class="p">)))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ord_vocab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_order</span> <span class="o">==</span> <span class="s1">&#39;concreteness&#39;</span><span class="p">:</span>
        <span class="c1"># Order by word concreteness</span>
        <span class="n">word_concs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">w</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">wn_concreteness</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">DataSets</span><span class="o">.</span><span class="n">fmri_vocab</span><span class="p">]</span>
        <span class="n">ord_med_vocab</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">cme</span><span class="p">,</span> <span class="n">cma</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">word_concs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">ord_max_vocab</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">cme</span><span class="p">,</span> <span class="n">cma</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">word_concs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>

        <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
        <span class="n">plot_data</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;fMRI&#39;</span><span class="p">,</span> <span class="n">ord_med_vocab</span><span class="p">,</span> <span class="s1">&#39;Median&#39;</span><span class="p">)</span>
        <span class="n">plot_data</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;MEG&#39;</span><span class="p">,</span> <span class="n">ord_med_vocab</span><span class="p">,</span> <span class="s1">&#39;Median&#39;</span><span class="p">)</span>
        <span class="n">plot_data</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;fMRI&#39;</span><span class="p">,</span> <span class="n">ord_max_vocab</span><span class="p">,</span> <span class="s1">&#39;Most concrete&#39;</span><span class="p">)</span>
        <span class="n">plot_data</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;MEG&#39;</span><span class="p">,</span> <span class="n">ord_max_vocab</span><span class="p">,</span> <span class="s1">&#39;Most concrete&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span>
        <span class="n">plot_data</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;fMRI&#39;</span><span class="p">,</span> <span class="n">DataSets</span><span class="o">.</span><span class="n">fmri_vocab</span><span class="p">,</span> <span class="n">plot_order</span><span class="p">)</span>
        <span class="n">plot_data</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;MEG&#39;</span><span class="p">,</span> <span class="n">DataSets</span><span class="o">.</span><span class="n">fmri_vocab</span><span class="p">,</span> <span class="n">plot_order</span><span class="p">)</span>

    <span class="n">legs</span><span class="p">,</span> <span class="n">leglabels</span> <span class="o">=</span> <span class="n">PlotColour</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span>   <span class="c1"># Leave out WordNet concreteness [1:]</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legs</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">leglabels</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;inherit&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=-</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="eval_dataset"><a class="viewcode-back" href="../../source.html#source.task_eval.eval_dataset">[docs]</a><span class="k">def</span> <span class="nf">eval_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
                 <span class="n">dataset_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">embeddings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
                 <span class="n">vocabs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
                 <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)),</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;ground_truth&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)]</span> <span class="o">+</span>
                            <span class="p">[(</span><span class="n">label</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">])</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Evaluate on </span><span class="si">{dataset_name}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">dataset</span><span class="p">)):</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;ground_truth&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">emb</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">vocabs</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">get_vec</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">emb</span><span class="p">,</span> <span class="n">vocab</span><span class="p">),</span> <span class="n">get_vec</span><span class="p">(</span><span class="n">w2</span><span class="p">,</span> <span class="n">emb</span><span class="p">,</span> <span class="n">vocab</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MISSING</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">==</span> <span class="n">MISSING</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Warning: No word pairs were found in </span><span class="si">{label}</span><span class="s1"> for </span><span class="si">{dataset_name}</span><span class="s1">!&#39;</span><span class="p">)</span>
        <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">scores</span><span class="p">,</span> <span class="n">pairs</span></div>


<div class="viewcode-block" id="plot_scores"><a class="viewcode-back" href="../../source.html#source.task_eval.plot_scores">[docs]</a><span class="k">def</span> <span class="nf">plot_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">gt_divisor</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">vecs_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colours</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;plot&#39;</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xtick_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">swapaxes</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Scatter plot of a structured array.&quot;&quot;&quot;</span>
    <span class="n">scs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;ground_truth&#39;</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
        <span class="n">scs</span><span class="p">[</span><span class="s1">&#39;ground_truth&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">gt_divisor</span>

    <span class="k">if</span> <span class="n">vecs_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vecs_names</span> <span class="o">=</span> <span class="n">scs</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">labs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vecs_names</span><span class="p">))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">labs</span> <span class="o">=</span> <span class="n">labels</span>
    <span class="k">if</span> <span class="n">colours</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">colours</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vecs_names</span><span class="p">))]</span>
    <span class="k">if</span> <span class="n">linestyles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">linestyles</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vecs_names</span><span class="p">))]</span>

    <span class="k">for</span> <span class="n">nm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">al</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vecs_names</span><span class="p">,</span> <span class="n">colours</span><span class="p">,</span> <span class="n">labs</span><span class="p">,</span> <span class="n">linestyles</span><span class="p">,</span> <span class="n">alphas</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">scs</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MISSING</span>  <span class="c1"># Leave out the pairs which aren&#39;t covered</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">scs</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">scs</span><span class="p">[</span><span class="n">nm</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">swapaxes</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">y</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">buf</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;scatter&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">al</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">al</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="plot_for_quantities"><a class="viewcode-back" href="../../source.html#source.task_eval.plot_for_quantities">[docs]</a><span class="k">def</span> <span class="nf">plot_for_quantities</span><span class="p">(</span><span class="n">scores</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">gt_divisor</span><span class="p">,</span> <span class="n">common_subset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pair_num</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">ling_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="s1">&#39;fqrng&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39;ground_truth&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">n</span>
                  <span class="ow">and</span> <span class="s1">&#39;+&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]</span>
    <span class="n">vis_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="s1">&#39;fqrng&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39;ground_truth&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39;model&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span>
                 <span class="ow">and</span> <span class="s1">&#39;+&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]</span>
    <span class="n">mm_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">vn</span> <span class="ow">in</span> <span class="n">vis_names</span><span class="p">:</span>
        <span class="n">mm_names</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="s1">&#39;fqrng&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39;ground_truth&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">n</span>
                        <span class="ow">and</span> <span class="n">vn</span> <span class="ow">in</span> <span class="n">n</span><span class="p">])</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">ling_names</span> <span class="o">+</span> <span class="n">vis_names</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">mm_names</span><span class="p">))</span>
    <span class="n">quantities</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ling_names</span><span class="p">])))</span>
    <span class="n">quantities</span> <span class="o">=</span> <span class="n">quantities</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">quantities</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>    <span class="c1"># -1: max train file num</span>
    <span class="n">scs</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;ground_truth&#39;</span><span class="p">]]</span>
    <span class="n">scs</span><span class="p">[</span><span class="s1">&#39;ground_truth&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">gt_divisor</span>
    <span class="n">correlations</span> <span class="o">=</span> <span class="n">compute_correlations</span><span class="p">(</span><span class="n">scs</span><span class="p">,</span> <span class="n">name_pairs</span><span class="o">=</span><span class="s1">&#39;gt&#39;</span><span class="p">,</span> <span class="n">common_subset</span><span class="o">=</span><span class="n">common_subset</span><span class="p">)</span>

    <span class="c1"># Plot data with error bars</span>
    <span class="k">def</span> <span class="nf">bar_data</span><span class="p">(</span><span class="n">nms</span><span class="p">):</span>
        <span class="n">means</span><span class="p">,</span> <span class="n">errs</span><span class="p">,</span> <span class="n">covs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quantities</span><span class="p">:</span>
            <span class="n">qnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nms</span> <span class="k">if</span> <span class="n">f</span><span class="s1">&#39;n</span><span class="si">{q}</span><span class="s1">_&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]</span>
            <span class="n">qcorrs</span><span class="p">,</span> <span class="n">qpvals</span><span class="p">,</span> <span class="n">qcoverages</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">correlations</span><span class="p">[</span><span class="s1">&#39;ground_truth | &#39;</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">qnames</span><span class="p">])</span>
            <span class="n">q_mean</span><span class="p">,</span> <span class="n">q_std</span><span class="p">,</span> <span class="n">q_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">qcorrs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">qcorrs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">qcoverages</span><span class="p">)</span>
            <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_mean</span><span class="p">)</span>
            <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_std</span><span class="p">)</span>
            <span class="n">covs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">q_cov</span> <span class="o">/</span> <span class="n">pair_num</span><span class="p">)</span>   <span class="c1"># Return coverage in percentages</span>
        <span class="k">return</span> <span class="n">means</span><span class="p">,</span> <span class="n">errs</span><span class="p">,</span> <span class="n">covs</span>

    <span class="n">ling_means</span><span class="p">,</span> <span class="n">ling_errs</span><span class="p">,</span> <span class="n">ling_covs</span> <span class="o">=</span> <span class="n">bar_data</span><span class="p">(</span><span class="n">ling_names</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">coverage_texts</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">covs</span><span class="p">,</span> <span class="n">errs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">xp</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">err</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">covs</span><span class="p">,</span> <span class="n">errs</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">err</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">cov</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">bar_width</span> <span class="o">=</span> <span class="mf">0.35</span>
    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">xpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">vis_names</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">quantities</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xpos</span><span class="p">),</span> <span class="n">ling_means</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ling_errs</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">bar_width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$E_L$&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">common_subset</span><span class="p">:</span>
        <span class="n">coverage_texts</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span> <span class="n">ling_means</span><span class="p">,</span> <span class="n">ling_covs</span><span class="p">,</span> <span class="n">ling_errs</span><span class="p">)</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">C</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># separate MM for vis_names too</span>
    <span class="k">for</span> <span class="n">mmn</span><span class="p">,</span> <span class="n">vn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mm_names</span><span class="p">,</span> <span class="n">vis_names</span><span class="p">):</span>
        <span class="n">mmlabel</span> <span class="o">=</span> <span class="s1">&#39;$E_L$ + &#39;</span> <span class="o">+</span> <span class="n">Embeddings</span><span class="o">.</span><span class="n">get_emb_type_label</span><span class="p">(</span><span class="n">vn</span><span class="p">)</span>
        <span class="n">mmn_means</span><span class="p">,</span> <span class="n">mmn_errs</span><span class="p">,</span> <span class="n">mmn_covs</span> <span class="o">=</span> <span class="n">bar_data</span><span class="p">(</span><span class="n">mmn</span><span class="p">)</span>
        <span class="n">mmn_xpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xpos</span><span class="p">)</span> <span class="o">+</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">bar_width</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">mmn_xpos</span><span class="p">,</span> <span class="n">mmn_means</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">mmn_errs</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">bar_width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">mmlabel</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;C</span><span class="si">{C}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">common_subset</span><span class="p">:</span>
            <span class="n">coverage_texts</span><span class="p">(</span><span class="n">mmn_xpos</span><span class="p">,</span> <span class="n">mmn_means</span><span class="p">,</span> <span class="n">mmn_covs</span><span class="p">,</span> <span class="n">mmn_errs</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">pi</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">vn</span> <span class="ow">in</span> <span class="n">vis_names</span><span class="p">:</span>
        <span class="n">vcorr</span><span class="p">,</span> <span class="n">vpval</span><span class="p">,</span> <span class="n">vcoverage</span> <span class="o">=</span> <span class="n">correlations</span><span class="p">[</span><span class="s1">&#39;ground_truth | &#39;</span> <span class="o">+</span> <span class="n">vn</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xpos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">bar_width</span> <span class="o">*</span> <span class="n">mmn_xpos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">vcorr</span><span class="p">,</span> <span class="n">vcorr</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="n">Embeddings</span><span class="o">.</span><span class="n">get_emb_type_label</span><span class="p">(</span><span class="n">vn</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;C</span><span class="si">{C}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">vcoverage</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">vcoverage</span> <span class="o">/</span> <span class="n">pair_num</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">common_subset</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bar_width</span> <span class="o">*</span> <span class="n">mmn_xpos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">vcorr</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">vcoverage</span><span class="p">)),</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># vxpos = np.array(xpos) + pi * bar_width</span>
        <span class="c1"># vcorrs = [vcorr for i in xpos]</span>
        <span class="c1"># verrs = [0 for i in xpos]</span>
        <span class="c1"># ax.bar(vxpos, vcorrs, yerr=verrs, width=bar_width, label=Embeddings.get_emb_type_label(vn))</span>
        <span class="c1"># coverage_texts(vxpos, vcorrs, [vcoverage for i in xpos], verrs)</span>
        <span class="c1"># pi += 1</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xpos</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;8M&#39;</span><span class="p">,</span> <span class="s1">&#39;1G&#39;</span><span class="p">,</span> <span class="s1">&#39;2G&#39;</span><span class="p">,</span> <span class="s1">&#39;5G&#39;</span><span class="p">,</span> <span class="s1">&#39;13G&#39;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Spearman correlation&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.08</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">columnspacing</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">common_subset</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">vcoverage</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="plot_for_freqranges"><a class="viewcode-back" href="../../source.html#source.task_eval.plot_for_freqranges">[docs]</a><span class="k">def</span> <span class="nf">plot_for_freqranges</span><span class="p">(</span><span class="n">scores</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">gt_divisor</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">common_subset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pair_num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">split_num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ds_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="s1">&#39;fqrng&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">f</span><span class="s1">&#39;n</span><span class="si">{quantity}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39;ground_truth&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span>
             <span class="ow">and</span> <span class="s1">&#39;common_subset&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">split_num</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">f</span><span class="s1">&#39;split</span><span class="si">{split_num}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ds_name</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">ds_name</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]</span>
    <span class="n">mixed</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="s1">&#39;n-1&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39;fqrng&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39;ground_truth&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]</span>
    <span class="n">ling_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39;+&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]</span>
    <span class="n">vis_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="s1">&#39;fqrng&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39;ground_truth&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39;model&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span>
                 <span class="ow">and</span> <span class="s1">&#39;+&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]</span>
    <span class="n">mm_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">vn</span> <span class="ow">in</span> <span class="n">vis_names</span><span class="p">:</span>
        <span class="n">mm_names</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">vn</span> <span class="ow">in</span> <span class="n">n</span><span class="p">])</span>

    <span class="n">names</span> <span class="o">=</span> <span class="n">ling_names</span> <span class="o">+</span> <span class="n">vis_names</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">mm_names</span><span class="p">))</span>
    <span class="n">scs</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;ground_truth&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">mixed</span><span class="p">]</span>
    <span class="n">scs</span><span class="p">[</span><span class="s1">&#39;ground_truth&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">gt_divisor</span>
    <span class="n">correlations</span> <span class="o">=</span> <span class="n">compute_correlations</span><span class="p">(</span><span class="n">scs</span><span class="p">,</span> <span class="n">name_pairs</span><span class="o">=</span><span class="s1">&#39;gt&#39;</span><span class="p">,</span> <span class="n">common_subset</span><span class="o">=</span><span class="n">common_subset</span><span class="p">)</span>

    <span class="n">freq_ranges</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)))</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ling_names</span><span class="p">])))</span>

    <span class="c1"># Plot data with error bars</span>
    <span class="k">def</span> <span class="nf">bar_data</span><span class="p">(</span><span class="n">nms</span><span class="p">,</span> <span class="n">mixed_pattern</span><span class="p">):</span>
        <span class="n">means</span><span class="p">,</span> <span class="n">errs</span><span class="p">,</span> <span class="n">covs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span> <span class="ow">in</span> <span class="n">freq_ranges</span><span class="p">:</span>
            <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nms</span> <span class="k">if</span> <span class="n">f</span><span class="s1">&#39;fqrng_</span><span class="si">{fmin}</span><span class="s1">-</span><span class="si">{fmax}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]</span>
            <span class="n">fcorrs</span><span class="p">,</span> <span class="n">fpvals</span><span class="p">,</span> <span class="n">fcoverages</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">correlations</span><span class="p">[</span><span class="s1">&#39;ground_truth | &#39;</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">])</span>
            <span class="n">f_mean</span><span class="p">,</span> <span class="n">f_std</span><span class="p">,</span> <span class="n">f_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fcorrs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">fcorrs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fcoverages</span><span class="p">)</span>
            <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_mean</span><span class="p">)</span>
            <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_std</span><span class="p">)</span>
            <span class="n">covs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">f_cov</span> <span class="o">/</span> <span class="n">pair_num</span><span class="p">)</span>
        <span class="c1"># MIXED: Full data</span>
        <span class="n">mcorrs</span><span class="p">,</span> <span class="n">mpvals</span><span class="p">,</span> <span class="n">mcoverages</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">correlations</span><span class="p">[</span><span class="s1">&#39;ground_truth | &#39;</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">mixed</span>
                                                                        <span class="k">if</span> <span class="n">mixed_pattern</span><span class="p">(</span><span class="n">n</span><span class="p">)])</span>
        <span class="n">m_mean</span><span class="p">,</span> <span class="n">m_std</span><span class="p">,</span> <span class="n">m_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mcorrs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">mcorrs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mcoverages</span><span class="p">)</span>
        <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m_mean</span><span class="p">)</span>
        <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m_std</span><span class="p">)</span>
        <span class="n">covs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">m_cov</span> <span class="o">/</span> <span class="n">pair_num</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">means</span><span class="p">,</span> <span class="n">errs</span><span class="p">,</span> <span class="n">covs</span>

    <span class="k">def</span> <span class="nf">coverage_texts</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">covs</span><span class="p">,</span> <span class="n">errs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">xp</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">err</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">covs</span><span class="p">,</span> <span class="n">errs</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">err</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">cov</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

    <span class="n">ling_means</span><span class="p">,</span> <span class="n">ling_errs</span><span class="p">,</span> <span class="n">ling_covs</span> <span class="o">=</span> <span class="n">bar_data</span><span class="p">(</span><span class="n">ling_names</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;+&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">bar_width</span> <span class="o">=</span> <span class="mf">0.35</span>
    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">xpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">vis_names</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">freq_ranges</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xpos</span><span class="p">),</span> <span class="n">ling_means</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ling_errs</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">bar_width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$E_L$&#39;</span><span class="p">)</span>
    <span class="n">coverage_texts</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span> <span class="n">ling_means</span><span class="p">,</span> <span class="n">ling_covs</span><span class="p">,</span> <span class="n">ling_errs</span><span class="p">)</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">C</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># separate MM for vis_names too</span>
    <span class="k">for</span> <span class="n">mmn</span><span class="p">,</span> <span class="n">vn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mm_names</span><span class="p">,</span> <span class="n">vis_names</span><span class="p">):</span>
        <span class="n">mmlabel</span> <span class="o">=</span> <span class="s1">&#39;$E_L$ + &#39;</span> <span class="o">+</span> <span class="n">Embeddings</span><span class="o">.</span><span class="n">get_emb_type_label</span><span class="p">(</span><span class="n">vn</span><span class="p">)</span>
        <span class="n">mmn_means</span><span class="p">,</span> <span class="n">mmn_errs</span><span class="p">,</span> <span class="n">mmn_covs</span> <span class="o">=</span> <span class="n">bar_data</span><span class="p">(</span><span class="n">mmn</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">vn</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">mmn_xpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xpos</span><span class="p">)</span> <span class="o">+</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">bar_width</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">mmn_xpos</span><span class="p">,</span> <span class="n">mmn_means</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">mmn_errs</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">bar_width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">mmlabel</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;C</span><span class="si">{C}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">coverage_texts</span><span class="p">(</span><span class="n">mmn_xpos</span><span class="p">,</span> <span class="n">mmn_means</span><span class="p">,</span> <span class="n">mmn_covs</span><span class="p">,</span> <span class="n">mmn_errs</span><span class="p">)</span>
        <span class="n">pi</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">C</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">vn</span> <span class="ow">in</span> <span class="n">vis_names</span><span class="p">:</span>
        <span class="n">vcorr</span><span class="p">,</span> <span class="n">vpval</span><span class="p">,</span> <span class="n">vcoverage</span> <span class="o">=</span> <span class="n">correlations</span><span class="p">[</span><span class="s1">&#39;ground_truth | &#39;</span> <span class="o">+</span> <span class="n">vn</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xpos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">bar_width</span> <span class="o">*</span> <span class="n">mmn_xpos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">vcorr</span><span class="p">,</span> <span class="n">vcorr</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="n">Embeddings</span><span class="o">.</span><span class="n">get_emb_type_label</span><span class="p">(</span><span class="n">vn</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;C</span><span class="si">{C}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">vcoverage</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">vcoverage</span> <span class="o">/</span> <span class="n">pair_num</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bar_width</span> <span class="o">*</span> <span class="n">mmn_xpos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">vcorr</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">vcoverage</span><span class="p">)),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># vxpos = np.array(xpos) + pi * bar_width</span>
        <span class="c1"># vcorrs = [vcorr for i in xpos]</span>
        <span class="c1"># verrs = [0 for i in xpos]</span>
        <span class="c1"># vcoverage = 100 * vcoverage / pair_num</span>
        <span class="c1"># ax.bar(vxpos, vcorrs, yerr=[0 for i in xpos], width=bar_width, label=Embeddings.get_label(vn))</span>
        <span class="c1"># coverage_texts(vxpos, vcorrs, [vcoverage for i in xpos], verrs)</span>
        <span class="c1"># pi += 1</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xpos</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;LOW&#39;</span><span class="p">,</span> <span class="s1">&#39;MEDIUM&#39;</span><span class="p">,</span> <span class="s1">&#39;HIGH&#39;</span><span class="p">,</span> <span class="s1">&#39;MIXED&#39;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Spearman correlation&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.08</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">columnspacing</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="wn_concreteness"><a class="viewcode-back" href="../../source.html#source.task_eval.wn_concreteness">[docs]</a><span class="k">def</span> <span class="nf">wn_concreteness</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">similarity_fn</span><span class="o">=</span><span class="n">wn</span><span class="o">.</span><span class="n">path_similarity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;WordNet distance of a word from its root hypernym.&quot;&quot;&quot;</span>
    <span class="n">syns</span> <span class="o">=</span> <span class="n">wn</span><span class="o">.</span><span class="n">synsets</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">similarity_fn</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">root_hypernyms</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">syns</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dists</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span></div>


<div class="viewcode-block" id="wn_concreteness_for_pairs"><a class="viewcode-back" href="../../source.html#source.task_eval.wn_concreteness_for_pairs">[docs]</a><span class="k">def</span> <span class="nf">wn_concreteness_for_pairs</span><span class="p">(</span><span class="n">word_pairs</span><span class="p">,</span> <span class="n">synset_agg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">similarity_fn</span><span class="o">=</span><span class="n">wn</span><span class="o">.</span><span class="n">path_similarity</span><span class="p">,</span>
                              <span class="n">pair_score_agg</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sort scores by first and second word&#39;s concreteness scores.</span>
<span class="sd">    :param pair_score_agg: &#39;sum&#39; adds scores for the two words, &#39;diff&#39; computes their absolute difference.</span>
<span class="sd">    :return (ids, scores): sorted score indices and concreteness scores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">synset_agg</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;median&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;most_conc&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}[</span><span class="n">synset_agg</span><span class="p">]</span>
    <span class="n">concrete_scores</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">wn_concreteness</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">similarity_fn</span><span class="p">)[</span><span class="n">synset_agg</span><span class="p">],</span>
                        <span class="n">wn_concreteness</span><span class="p">(</span><span class="n">w2</span><span class="p">,</span> <span class="n">similarity_fn</span><span class="p">)[</span><span class="n">synset_agg</span><span class="p">])</span>
                       <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">word_pairs</span><span class="p">)]</span>
    <span class="c1"># Sort for word pairs</span>
    <span class="k">if</span> <span class="n">pair_score_agg</span> <span class="o">==</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span>
        <span class="n">agg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">pair_score_agg</span> <span class="o">==</span> <span class="s1">&#39;diff&#39;</span><span class="p">:</span>
        <span class="n">agg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ids12</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">agg</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">concrete_scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">agg</span><span class="p">)]</span>
    <span class="n">ids</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">ids12</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_by_concreteness"><a class="viewcode-back" href="../../source.html#source.task_eval.plot_by_concreteness">[docs]</a><span class="k">def</span> <span class="nf">plot_by_concreteness</span><span class="p">(</span><span class="n">scores</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">word_pairs</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">common_subset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vecs_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">concrete_num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">title_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pair_score_agg</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot scores for data splits with increasing concreteness.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">synset_agg</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;most_conc&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]):</span>
        <span class="n">corrs_by_conc</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">ids12</span><span class="p">,</span> <span class="n">concs</span> <span class="o">=</span> <span class="n">wn_concreteness_for_pairs</span><span class="p">(</span><span class="n">word_pairs</span><span class="p">,</span> <span class="n">synset_agg</span><span class="p">,</span> <span class="n">pair_score_agg</span><span class="o">=</span><span class="n">pair_score_agg</span><span class="p">)</span>
        <span class="n">scs</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">ids12</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids12</span><span class="p">),</span> <span class="n">concrete_num</span><span class="p">):</span>
            <span class="n">corrs</span> <span class="o">=</span> <span class="n">compute_correlations</span><span class="p">(</span><span class="n">scs</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">concrete_num</span><span class="p">],</span> <span class="s1">&#39;gt&#39;</span><span class="p">,</span> <span class="n">common_subset</span><span class="o">=</span><span class="n">common_subset</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">corrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">corrs_by_conc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Append correlations score for each embedding</span>

        <span class="n">corrs_by_conc_a</span> <span class="o">=</span> <span class="n">dict2struct_array</span><span class="p">(</span><span class="n">corrs_by_conc</span><span class="p">)</span>

        <span class="n">vnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">corrs_by_conc_a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="s1">&#39;fmri&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39;frcnn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Embeddings</span><span class="o">.</span><span class="n">get_label</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">NAME_DELIM</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">vnames</span><span class="p">]</span>

        <span class="n">colours</span><span class="p">,</span> <span class="n">linestyles</span><span class="p">,</span> <span class="n">alphas</span> <span class="o">=</span> <span class="n">PlotColour</span><span class="o">.</span><span class="n">colour_by_modality</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">labelpad</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="c1"># Concreteness scores on different axis but the same plot</span>
        <span class="n">axn</span> <span class="o">=</span> <span class="n">ax</span>
        <span class="n">axn</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">concs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="n">axn</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Word pairs&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="n">labelpad</span><span class="p">)</span>
        <span class="n">axn</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;WordNet concreteness&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="n">labelpad</span><span class="p">)</span>
        <span class="n">axn</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="c1"># Xticklabels by step size</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="n">xtlabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">concrete_num</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">axn</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xtlabels</span><span class="p">])</span>
        <span class="n">axn</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xtlabels</span><span class="p">)</span>

        <span class="c1"># Plot for Spearman&#39;s correlations</span>
        <span class="n">axp</span> <span class="o">=</span> <span class="n">axn</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">axp</span> <span class="o">=</span> <span class="n">plot_scores</span><span class="p">(</span><span class="n">corrs_by_conc_a</span><span class="p">,</span>
                          <span class="n">vecs_names</span><span class="o">=</span><span class="n">vnames</span><span class="p">,</span>
                          <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">colours</span><span class="o">=</span><span class="n">colours</span><span class="p">,</span>
                          <span class="n">linestyles</span><span class="o">=</span><span class="n">linestyles</span><span class="p">,</span>
                          <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                          <span class="n">alphas</span><span class="o">=</span><span class="n">alphas</span><span class="p">,</span>
                          <span class="n">xtick_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">ax</span><span class="o">=</span><span class="n">axp</span><span class="p">,</span>
                          <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">)</span>
        <span class="n">axp</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Spearman&#39;s correlation&quot;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="n">labelpad</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
        <span class="c1"># TODO: Doesn&#39;t show, order of axn.twiny().twinx() matters...</span>
        <span class="n">axp</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;WordNet concreteness splits by 100 pairs&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="n">labelpad</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">corrs_by_conc_a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">axp</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)])</span>
        <span class="n">axp</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axp</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()])</span>
        <span class="n">syna</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;median&#39;</span><span class="p">:</span> <span class="s1">&#39;Median&#39;</span><span class="p">,</span> <span class="s1">&#39;most_conc&#39;</span><span class="p">:</span> <span class="s1">&#39;Most Concrete&#39;</span><span class="p">}[</span><span class="n">synset_agg</span><span class="p">]</span>
        <span class="n">axp</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{title_prefix}</span><span class="s1"> - Synset Agg </span><span class="si">{syna}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="eval_concreteness"><a class="viewcode-back" href="../../source.html#source.task_eval.eval_concreteness">[docs]</a><span class="k">def</span> <span class="nf">eval_concreteness</span><span class="p">(</span><span class="n">scores</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">word_pairs</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">gt_divisor</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">vecs_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;simple&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Eval dataset instances based on WordNet synsets.&quot;&quot;&quot;</span>

    <span class="c1"># Sort scores by first and second word&#39;s concreteness scores</span>
    <span class="k">def</span> <span class="nf">print_conc</span><span class="p">(</span><span class="n">synset_agg</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
        <span class="n">ids12</span> <span class="o">=</span> <span class="n">wn_concreteness_for_pairs</span><span class="p">(</span><span class="n">word_pairs</span><span class="p">,</span> <span class="n">synset_agg</span><span class="p">)</span>
        <span class="c1"># plot_scores(scores[ids1], gt_divisor, vecs_names, title=title)</span>
        <span class="c1"># plot_scores(scores[ids2], gt_divisor, vecs_names, title=title)</span>
        <span class="c1"># plot_scores(scores[ids12][:100], gt_divisor, vecs_names, title=title + &#39; - 100 least concrete&#39;)</span>
        <span class="c1"># plot_scores(scores[ids12][-100:], gt_divisor, vecs_names, title=title + &#39; - 100 most concrete&#39;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-------- </span><span class="si">{num}</span><span class="s1"> least concrete - </span><span class="si">{title}</span><span class="s1"> -------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">print_correlations</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">ids12</span><span class="p">][:</span><span class="n">num</span><span class="p">],</span> <span class="n">name_pairs</span><span class="o">=</span><span class="s1">&#39;gt&#39;</span><span class="p">,</span> <span class="n">common_subset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="n">tablefmt</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-------- </span><span class="si">{num}</span><span class="s1"> most concrete - </span><span class="si">{title}</span><span class="s1"> -------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">print_correlations</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">ids12</span><span class="p">][</span><span class="o">-</span><span class="n">num</span><span class="p">:],</span> <span class="n">name_pairs</span><span class="o">=</span><span class="s1">&#39;gt&#39;</span><span class="p">,</span> <span class="n">common_subset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="n">tablefmt</span><span class="p">)</span>

    <span class="c1"># plots both for median concreteness of synsets and for the most concrete synset of words</span>
    <span class="n">print_conc</span><span class="p">(</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;Median synset concreteness&#39;</span><span class="p">)</span>
    <span class="n">print_conc</span><span class="p">(</span><span class="s1">&#39;most_conc&#39;</span><span class="p">,</span> <span class="s1">&#39;Most concrete synsets&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_scores"><a class="viewcode-back" href="../../source.html#source.task_eval.compute_scores">[docs]</a><span class="k">def</span> <span class="nf">compute_scores</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">brain_scores</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pre_score_files</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">ling_vecs_names</span><span class="o">=</span><span class="p">[],</span> <span class="n">vecs_names</span><span class="o">=</span><span class="p">[],</span> <span class="n">mm_lingvis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mm_embs_of</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">mm_padding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">common_subset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute scores on all evaluation datasets.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
    <span class="n">embs</span> <span class="o">=</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">embeddings</span>
    <span class="n">vocabs</span> <span class="o">=</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">vocabs</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">vecs_names</span>

    <span class="c1"># Create multi-modal embeddings if ligvis or specific embedding pairs are given</span>
    <span class="k">if</span> <span class="n">mm_lingvis</span> <span class="ow">or</span> <span class="n">mm_embs_of</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mm_lingvis</span><span class="p">:</span>  <span class="c1"># TODO: test</span>
            <span class="n">mm_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">ling_vecs_names</span><span class="p">,</span> <span class="n">vecs_names</span><span class="p">))</span>
            <span class="n">emb_tuples</span> <span class="o">=</span> <span class="p">[(</span><span class="n">embs</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ln</span><span class="p">)],</span> <span class="n">embs</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vn</span><span class="p">)])</span> <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">vn</span> <span class="ow">in</span> <span class="n">mm_labels</span><span class="p">]</span>
            <span class="n">vocab_tuples</span> <span class="o">=</span> <span class="p">[(</span><span class="n">vocabs</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ln</span><span class="p">)],</span> <span class="n">vocabs</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vn</span><span class="p">)])</span> <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">vn</span> <span class="ow">in</span> <span class="n">mm_labels</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">mm_embs_of</span><span class="p">:</span>  <span class="c1"># Create MM Embeddings based on the given embedding labels</span>
            <span class="n">emb_tuples</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">embs</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mm_embs_of</span><span class="p">]</span>
            <span class="n">vocab_tuples</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">vocabs</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mm_embs_of</span><span class="p">]</span>
            <span class="n">mm_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mm_embs_of</span><span class="p">]</span>

        <span class="n">mm_embeddings</span><span class="p">,</span> <span class="n">mm_vocabs</span><span class="p">,</span> <span class="n">mm_labels</span> <span class="o">=</span> <span class="n">mid_fusion</span><span class="p">(</span><span class="n">emb_tuples</span><span class="p">,</span> <span class="n">vocab_tuples</span><span class="p">,</span> <span class="n">mm_labels</span><span class="p">,</span> <span class="n">mm_padding</span><span class="p">)</span>
        <span class="n">embs</span> <span class="o">+=</span> <span class="n">mm_embeddings</span>
        <span class="n">vocabs</span> <span class="o">+=</span> <span class="n">mm_vocabs</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="n">mm_labels</span>

    <span class="k">if</span> <span class="s1">&#39;compscores&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>  <span class="c1"># SemSim scores</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dscores</span><span class="p">,</span> <span class="n">dpairs</span> <span class="o">=</span> <span class="n">eval_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">embs</span><span class="p">,</span> <span class="n">vocabs</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>
            <span class="n">scores</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dscores</span>
            <span class="n">pairs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dpairs</span>

        <span class="k">if</span> <span class="n">pre_score_files</span><span class="p">:</span>  <span class="c1"># Load previously saved score files and add the new scores.</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Load </span><span class="si">{pre_score_files}</span><span class="s1"> and join with new scores...&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">pre_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{pre_score_files}</span><span class="s1">_</span><span class="si">{name}</span><span class="s1">.npy&#39;</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">join_struct_arrays</span><span class="p">([</span><span class="n">pre_scores</span><span class="p">,</span> <span class="n">scores</span><span class="p">[</span><span class="n">name</span><span class="p">]])</span>

    <span class="k">if</span> <span class="s1">&#39;compbrain&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>  <span class="c1"># Brain scores</span>
        <span class="k">if</span> <span class="n">common_subset</span><span class="p">:</span>  <span class="c1"># Intersection of all vocabs for two_vs_two and it filters out the common subset</span>
            <span class="n">vocabs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">vocabs</span><span class="p">)))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vocabs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">emb</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">embs</span><span class="p">,</span> <span class="n">vocabs</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
            <span class="n">fMRI_scores</span><span class="p">,</span> <span class="n">MEG_scores</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">fMRI_scores_avg</span><span class="p">,</span> <span class="n">MEG_scores_avg</span><span class="p">,</span> \
            <span class="n">fMRI_word_scores</span><span class="p">,</span> <span class="n">MEG_word_scores</span> <span class="o">=</span> <span class="n">two_vs_two</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span><span class="n">embedding</span><span class="o">=</span><span class="n">emb</span><span class="p">,</span> <span class="n">vocab</span><span class="o">=</span><span class="n">vocab</span><span class="p">)</span>
            <span class="n">brain_scores</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fMRI&#39;</span><span class="p">:</span> <span class="n">fMRI_scores</span><span class="p">,</span> <span class="s1">&#39;MEG&#39;</span><span class="p">:</span> <span class="n">MEG_scores</span><span class="p">,</span>
                                  <span class="s1">&#39;fMRI Avg&#39;</span><span class="p">:</span> <span class="n">fMRI_scores_avg</span><span class="p">,</span> <span class="s1">&#39;MEG Avg&#39;</span><span class="p">:</span> <span class="n">MEG_scores_avg</span><span class="p">,</span>
                                  <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="n">length</span><span class="p">,</span>
                                  <span class="s1">&#39;fMRI words&#39;</span><span class="p">:</span> <span class="n">fMRI_word_scores</span><span class="p">,</span> <span class="s1">&#39;MEG words&#39;</span><span class="p">:</span> <span class="n">MEG_word_scores</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">pre_score_files</span><span class="p">:</span>  <span class="c1"># Load previously saved score files and add the new scores.</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{pre_score_files}</span><span class="s1">_brain.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pre_brain_scores</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">pbscores</span> <span class="ow">in</span> <span class="n">pre_brain_scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">brain_scores</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pbscores</span>

    <span class="k">return</span> <span class="n">scores</span><span class="p">,</span> <span class="n">brain_scores</span><span class="p">,</span> <span class="n">pairs</span></div>


<span class="c1"># TODO: Nicer parameter handling, with exception messages</span>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../source.html#source.task_eval.main">[docs]</a><span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="s1">&#39;--actions&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
     <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;printcorr&#39;</span><span class="p">,</span> <span class="s1">&#39;plotscores&#39;</span><span class="p">,</span> <span class="s1">&#39;concreteness&#39;</span><span class="p">,</span> <span class="s1">&#39;coverage&#39;</span><span class="p">,</span> <span class="s1">&#39;compscores&#39;</span><span class="p">,</span> <span class="s1">&#39;compbrain&#39;</span><span class="p">,</span>
              <span class="s1">&#39;brainwords&#39;</span><span class="p">,</span> <span class="s1">&#39;printbraincorr&#39;</span><span class="p">,</span> <span class="s1">&#39;plot_quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;plot_freqrange&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;printcorr&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;-lvns&#39;</span><span class="p">,</span> <span class="s1">&#39;--ling_vecs_names&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
     <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;w2v13&#39;</span><span class="p">,</span> <span class="s1">&#39;wikinews&#39;</span><span class="p">,</span> <span class="s1">&#39;wikinews_sub&#39;</span><span class="p">,</span> <span class="s1">&#39;crawl&#39;</span><span class="p">,</span> <span class="s1">&#39;crawl_sub&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="p">[])</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;-vns&#39;</span><span class="p">,</span> <span class="s1">&#39;--vecs_names&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;-plto&#39;</span><span class="p">,</span> <span class="s1">&#39;--plot_orders&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;-pltv&#39;</span><span class="p">,</span> <span class="s1">&#39;--plot_vecs&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;-mmembs&#39;</span><span class="p">,</span> <span class="s1">&#39;--mm_embs_of&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">tuple_list</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;-pcorr&#39;</span><span class="p">,</span> <span class="s1">&#39;--print_corr_for&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">embdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">vecs_names</span><span class="o">=</span><span class="p">[],</span> <span class="n">savepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">loadpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
         <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;plotcorr&#39;</span><span class="p">],</span> <span class="n">plot_orders</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ground_truth&#39;</span><span class="p">],</span> <span class="n">plot_vecs</span><span class="o">=</span><span class="p">[],</span>
         <span class="n">ling_vecs_names</span><span class="o">=</span><span class="p">[],</span> <span class="n">pre_score_files</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mm_embs_of</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
         <span class="n">mm_lingvis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mm_padding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_corr_for</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">common_subset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
         <span class="n">tablefmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;simple&quot;</span><span class="p">,</span> <span class="n">concrete_num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">pair_score_agg</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param actions: Choose from the following:</span>
<span class="sd">        &#39;printcorr&#39;: Print correlation in tables on MEN and SimLex.</span>
<span class="sd">        &#39;plotscores&#39;: Plot correlations on MEN and SimLex.</span>
<span class="sd">        &#39;concreteness&#39;: Scores on caption_comsub Semantic Similarity dataset splits, ordered by pair_score_agg of</span>
<span class="sd">                        WordNet concreteness scores of the two words in every word pair.</span>
<span class="sd">                        Optional: mm_padding</span>
<span class="sd">        &#39;coverage&#39;: Save coverages on similarity/relatedness/brain data.</span>
<span class="sd">        &#39;compscores&#39;: Compute scores on similarity/relatedness evaluation datasets.</span>
<span class="sd">        &#39;compbrain&#39;: Compute scores on brain evaluation datasets.</span>
<span class="sd">        &#39;brainwords&#39;: Plot Qualitative analysis on words in the brain data.</span>
<span class="sd">        &#39;printbraincorr&#39;: Print correlations on brain data.</span>
<span class="sd">        &#39;plot_quantity&#39;: Plot similarity/relatedness result for text quantity ranges.</span>
<span class="sd">        &#39;plot_freqrange&#39;: Plot similarity/relatedness result for wor frequency ranges.</span>
<span class="sd">    :param pair_score_agg: &#39;sum&#39; or &#39;diff&#39; of concreteness scores of word pairs.</span>
<span class="sd">    :param mm_lingvis: if True, create multi-modal embeddings, otherwise specific embedding pairs should be given.</span>
<span class="sd">    :param tablefmt: printed table format. &#39;simple&#39; - terminal, &#39;latex_raw&#39; - latex table.</span>
<span class="sd">    :param concrete_num: Plot of WordNet concreteness splits by concrete_num number of pairs.</span>
<span class="sd">    :param datadir: Path to directory which contains evaluation data (and embedding data if embdir is not given)</span>
<span class="sd">    :param vecs_names: List[str] Names of embeddings</span>
<span class="sd">    :param embdir: Path to directory which contains embedding files.</span>
<span class="sd">    :param savepath: Full path to the file to save scores without extension. None if there&#39;s no saving.</span>
<span class="sd">    :param loadpath: Full path to the files to load scores and brain results from without extension.</span>
<span class="sd">                     If None, they&#39;ll be computed.</span>
<span class="sd">    :param plot_orders: Performance plot ordered by similarity scores of these datasets or embeddings.</span>
<span class="sd">    :param plot_vecs: List[str] Names of embeddings to plot scores for.</span>
<span class="sd">    :param ling_vecs_names: List[str] Names of linguistic embeddings.</span>
<span class="sd">    :param pre_score_files: Previously saved score file path without extension, which the new scores will be merged with</span>
<span class="sd">    :param mm_embs_of: List of str tuples, where the tuples contain names of embeddings which are to</span>
<span class="sd">                       be concatenated into a multi-modal mid-fusion embedding.</span>
<span class="sd">    :param mm_padding: Default False. Multi-modal mid-fusion method. If true, all the vectors are kept from the embeddings&#39; vocabularies.</span>
<span class="sd">                       Vector representations without a vector from another modality are padded with zeros.</span>
<span class="sd">    :param print_corr_for: &#39;gt&#39; prints correlations scores for ground truth, &#39;all&#39; prints scores between all</span>
<span class="sd">                            pairs of scores.</span>
<span class="sd">    :param common_subset: action printcorr: Print results for subests of the eval datasets which are covered by all</span>
<span class="sd">                          embeddings&#39; vocabularies.</span>
<span class="sd">                          action compbarin: Compute brain scores for interection of vocabularies.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">brain_scores</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">datasets</span> <span class="o">=</span> <span class="n">DataSets</span><span class="p">(</span><span class="n">datadir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">loadpath</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">score_file</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{loadpath}</span><span class="s1">_</span><span class="si">{name}</span><span class="s1">.npy&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">score_file</span><span class="p">):</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{loadpath}</span><span class="s1">_</span><span class="si">{name}</span><span class="s1">.npy&#39;</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{loadpath}</span><span class="s1">_brain.json&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{loadpath}</span><span class="s1">_brain.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">brain_scores</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># For printing tables</span>
        <span class="k">if</span> <span class="s1">&#39;nopadding&#39;</span> <span class="ow">in</span> <span class="n">loadpath</span><span class="p">:</span>
            <span class="n">title_pad</span> <span class="o">=</span> <span class="s1">&#39;Intersection&#39;</span>
            <span class="n">fname_pad</span> <span class="o">=</span> <span class="s1">&#39;nopadding&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title_pad</span> <span class="o">=</span> <span class="s1">&#39;Padding&#39;</span>
            <span class="n">fname_pad</span> <span class="o">=</span> <span class="s1">&#39;padding&#39;</span>

        <span class="n">score_explanation0</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Multi-modal embeddings are created using the </span><span class="si">{title_pad}</span><span class="s1"> technique. &#39;</span> <span class="o">+</span> \
                            <span class="s1">&#39;The table sections contain linguistic, visual and multi-modal embeddings in this order. &#39;</span>

        <span class="n">score_explanation</span> <span class="o">=</span> <span class="n">score_explanation0</span> <span class="o">+</span> \
                            <span class="s1">&#39;Red colour signifies the best performance, blue means that the multi-modal &#39;</span> <span class="o">+</span> \
                            <span class="s1">&#39;embedding outperformed the corresponding uni-modal ones.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">embdir</span><span class="p">:</span>
            <span class="n">embdir</span> <span class="o">=</span> <span class="n">datadir</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">Embeddings</span><span class="p">(</span><span class="n">embdir</span><span class="p">,</span> <span class="n">vecs_names</span><span class="p">,</span> <span class="n">ling_vecs_names</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;compscores&#39;</span> <span class="ow">in</span> <span class="n">actions</span> <span class="ow">or</span> <span class="s1">&#39;compbrain&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="n">scores</span><span class="p">,</span> <span class="n">brain_scores</span><span class="p">,</span> <span class="n">pairs</span> <span class="o">=</span> <span class="n">compute_scores</span><span class="p">(</span>
            <span class="n">actions</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">brain_scores</span><span class="o">=</span><span class="n">brain_scores</span><span class="p">,</span>
            <span class="n">pre_score_files</span><span class="o">=</span><span class="n">pre_score_files</span><span class="p">,</span> <span class="n">ling_vecs_names</span><span class="o">=</span><span class="n">ling_vecs_names</span><span class="p">,</span> <span class="n">vecs_names</span><span class="o">=</span><span class="n">vecs_names</span><span class="p">,</span>
            <span class="n">mm_lingvis</span><span class="o">=</span><span class="n">mm_lingvis</span><span class="p">,</span> <span class="n">mm_embs_of</span><span class="o">=</span><span class="n">mm_embs_of</span><span class="p">,</span> <span class="n">mm_padding</span><span class="o">=</span><span class="n">mm_padding</span><span class="p">,</span> <span class="n">common_subset</span><span class="o">=</span><span class="n">common_subset</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;plot_quantity&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">scrs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="n">coverage</span> <span class="o">=</span> <span class="n">plot_for_quantities</span><span class="p">(</span><span class="n">scrs</span><span class="p">,</span> <span class="n">gt_divisor</span><span class="o">=</span><span class="n">datasets</span><span class="o">.</span><span class="n">normalizers</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">common_subset</span><span class="o">=</span><span class="n">common_subset</span><span class="p">,</span>
                                <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pair_num</span><span class="o">=</span><span class="n">datasets</span><span class="o">.</span><span class="n">pair_num</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="n">cstag</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;common_subset_</span><span class="si">{coverage}</span><span class="s1">_&#39;</span> <span class="k">if</span> <span class="n">common_subset</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;../figs/quantities_lines_</span><span class="si">{cstag}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;plot_freqrange&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">scrs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="n">plot_for_freqranges</span><span class="p">(</span><span class="n">scrs</span><span class="p">,</span> <span class="n">gt_divisor</span><span class="o">=</span><span class="n">datasets</span><span class="o">.</span><span class="n">normalizers</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">common_subset</span><span class="o">=</span><span class="n">common_subset</span><span class="p">,</span>
                                <span class="n">quantity</span><span class="o">=</span><span class="n">quantity</span><span class="p">,</span> <span class="n">pair_num</span><span class="o">=</span><span class="n">datasets</span><span class="o">.</span><span class="n">pair_num</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">split_num</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ds_name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="n">cstag</span> <span class="o">=</span> <span class="s1">&#39;common_subset_&#39;</span> <span class="k">if</span> <span class="n">common_subset</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;../figs/eqsplit_freqranges_lines_</span><span class="si">{cstag}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;plotscores&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">scrs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">plot_order</span> <span class="ow">in</span> <span class="n">plot_orders</span><span class="p">:</span>  <span class="c1"># order similarity scores of these datasets or embeddings</span>
                <span class="n">plot_scores</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">scrs</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">plot_order</span><span class="p">),</span> <span class="n">gt_divisor</span><span class="o">=</span><span class="n">datasets</span><span class="o">.</span><span class="n">normalizers</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                            <span class="n">vecs_names</span><span class="o">=</span><span class="n">plot_vecs</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;ground_truth&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="s1">&#39;concreteness&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">loadpath</span> <span class="o">+</span> <span class="s1">&#39;_pairs.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">word_pairs</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">common_subset</span><span class="p">:</span>
            <span class="n">commonsub</span> <span class="o">=</span> <span class="s1">&#39;commonsubset&#39;</span>
            <span class="n">caption_comsub</span> <span class="o">=</span> <span class="s2">&quot;the embeddings&#39; common subset of&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">commonsub</span> <span class="o">=</span> <span class="s1">&#39;full&#39;</span>
            <span class="n">caption_comsub</span> <span class="o">=</span> <span class="s2">&quot;the full&quot;</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">scrs</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="c1"># print(f&#39;\n-------- {name} scores -------\n&#39;)</span>
            <span class="c1"># eval_concreteness(scrs, word_pairs[name], num=concrete_num,</span>
            <span class="c1">#                   gt_divisor=datasets.normalizers[name], vecs_names=plot_vecs + [&#39;ground_truth&#39;],</span>
            <span class="c1">#                   tablefmt=tablefmt)</span>
            <span class="n">plot_by_concreteness</span><span class="p">(</span><span class="n">scrs</span><span class="p">,</span> <span class="n">word_pairs</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">common_subset</span><span class="o">=</span><span class="n">common_subset</span><span class="p">,</span>
                                 <span class="n">vecs_names</span><span class="o">=</span><span class="n">plot_vecs</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;ground_truth&#39;</span><span class="p">],</span>
                                 <span class="n">concrete_num</span><span class="o">=</span><span class="n">concrete_num</span><span class="p">,</span>
                                 <span class="n">title_prefix</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                 <span class="n">pair_score_agg</span><span class="o">=</span><span class="n">pair_score_agg</span><span class="p">,</span>
                                 <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">legs</span><span class="p">,</span> <span class="n">leglabels</span> <span class="o">=</span> <span class="n">PlotColour</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legs</span><span class="p">,</span> <span class="n">leglabels</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;inherit&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=-</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">agg</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sum&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;diff&#39;</span><span class="p">:</span> <span class="s1">&#39;difference&#39;</span><span class="p">}[</span><span class="n">pair_score_agg</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{commonsub}</span><span class="s1">_</span><span class="si">{fname_pad}</span><span class="s1">_</span><span class="si">{pair_score_agg}</span><span class="s1">&#39;</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="s1">&#39;figs/&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
        <span class="n">latex_fig</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin</span><span class="si">{figure}</span><span class="se">\n</span><span class="s1">\centering</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;\includegraphics[width=</span><span class="se">\\</span><span class="s1">textwidth]{figs/&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.png}&#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">\caption{&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="s1">&#39;Scores on </span><span class="si">{caption_comsub}</span><span class="s1"> Semantic Similarity dataset splits, ordered by &#39;</span> <span class="o">+</span> \
                    <span class="n">f</span><span class="s1">&#39;the </span><span class="si">{agg}</span><span class="s1"> of WordNet concreteness scores of &#39;</span> <span class="o">+</span> \
                    <span class="n">f</span><span class="s1">&#39;the two words in every word pair. Mid-fusion method: </span><span class="si">{title_pad}</span><span class="s1">.&#39;</span> <span class="o">+</span> <span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;\label{f:&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">\end</span><span class="si">{figure}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="c1"># Save figure and figures tex file</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;figs/figs_concreteness.tex&#39;</span><span class="p">,</span> <span class="s1">&#39;a+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">latex_fig</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;brainwords&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="n">plot_brain_words</span><span class="p">(</span><span class="n">brain_scores</span><span class="p">,</span> <span class="s1">&#39;VG-VIS combined&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;commonsubset&#39;</span> <span class="ow">in</span> <span class="n">loadpath</span><span class="p">:</span>
            <span class="n">commonsub</span> <span class="o">=</span> <span class="s1">&#39;commonsubset&#39;</span>
            <span class="n">caption_comsub</span> <span class="o">=</span> <span class="s2">&quot;the embeddings&#39; common subset of&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">commonsub</span> <span class="o">=</span> <span class="s1">&#39;full&#39;</span>
            <span class="n">caption_comsub</span> <span class="o">=</span> <span class="s2">&quot;the full&quot;</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;brain_</span><span class="si">{commonsub}</span><span class="s1">_</span><span class="si">{fname_pad}</span><span class="s1">&#39;</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="s1">&#39;figs/&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
        <span class="n">latex_fig</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin</span><span class="si">{figure}</span><span class="se">\n</span><span class="s1">\centering</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;\includegraphics[width=</span><span class="se">\\</span><span class="s1">textwidth]{figs/&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.png}&#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">\caption{&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="s1">&#39;Scores on </span><span class="si">{caption_comsub}</span><span class="s1"> the Brain datasets words, ordered by &#39;</span> <span class="o">+</span> \
                    <span class="n">f</span><span class="s1">&#39;their WordNet concreteness. The scores are the number of hits per word, averaged over &#39;</span> <span class="o">+</span> \
                    <span class="n">f</span><span class="s1">&#39;all participants. Mid-fusion method: </span><span class="si">{title_pad}</span><span class="s1">.&#39;</span> <span class="o">+</span> <span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;\label{f:&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">\end</span><span class="si">{figure}</span><span class="se">\n\n</span><span class="s1">&#39;</span>

        <span class="c1"># Save figure and figures tex file</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;figs/figs_brain.tex&#39;</span><span class="p">,</span> <span class="s1">&#39;a+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">latex_fig</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;printcorr&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scores</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">scrs</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># print(f&#39;\n-------- {name} scores -------\n&#39;)</span>
                <span class="k">if</span> <span class="n">common_subset</span><span class="p">:</span>
                    <span class="n">caption</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Spearman correlation on the common subset of the </span><span class="si">{name}</span><span class="s1"> dataset. &#39;</span>
                    <span class="n">commonsub</span> <span class="o">=</span> <span class="s1">&#39;commonsubset&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">caption</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Spearman correlation on the </span><span class="si">{name}</span><span class="s1"> dataset. &#39;</span>
                    <span class="n">commonsub</span> <span class="o">=</span> <span class="s1">&#39;full&#39;</span>
                <span class="n">print_correlations</span><span class="p">(</span><span class="n">scrs</span><span class="p">,</span> <span class="n">name_pairs</span><span class="o">=</span><span class="n">print_corr_for</span><span class="p">,</span> <span class="n">common_subset</span><span class="o">=</span><span class="n">common_subset</span><span class="p">,</span>
                                   <span class="n">tablefmt</span><span class="o">=</span><span class="n">tablefmt</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">caption</span> <span class="o">+</span> <span class="n">score_explanation</span><span class="p">,</span>
                                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">commonsub</span><span class="p">,</span> <span class="n">fname_pad</span><span class="p">]))</span>

    <span class="k">if</span> <span class="s1">&#39;printcorr_subsample&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scores</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">scrs</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># print(f&#39;\n-------- {name} scores -------\n&#39;)</span>
                <span class="k">if</span> <span class="n">common_subset</span><span class="p">:</span>
                    <span class="n">caption</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Cross-validated Spearman correlations on the common subset of the </span><span class="si">{name}</span><span class="s1"> dataset. &#39;</span>
                    <span class="n">commonsub</span> <span class="o">=</span> <span class="s1">&#39;commonsubset&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">caption</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Cross-validated Spearman correlations on the </span><span class="si">{name}</span><span class="s1"> dataset. &#39;</span>
                    <span class="n">commonsub</span> <span class="o">=</span> <span class="s1">&#39;full&#39;</span>
                <span class="n">caption</span> <span class="o">+=</span> <span class="s1">&#39;Spearman and P-value columns report $&lt;$mean (STD)$&gt;$ of three samples after leaving out the third of the evaluation pairs. &#39;</span>
                <span class="n">print_subsampled_correlations</span><span class="p">(</span><span class="n">scrs</span><span class="p">,</span> <span class="n">name_pairs</span><span class="o">=</span><span class="n">print_corr_for</span><span class="p">,</span> <span class="n">common_subset</span><span class="o">=</span><span class="n">common_subset</span><span class="p">,</span>
                                   <span class="n">tablefmt</span><span class="o">=</span><span class="n">tablefmt</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">caption</span> <span class="o">+</span> <span class="n">score_explanation0</span><span class="p">,</span>
                                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">commonsub</span><span class="p">,</span> <span class="n">fname_pad</span><span class="p">,</span> <span class="s1">&#39;crossval&#39;</span><span class="p">]),</span> <span class="n">n_sample</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;printbraincorr&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;commonsubset&#39;</span> <span class="ow">in</span> <span class="n">loadpath</span><span class="p">:</span>
            <span class="n">caption_suffix</span> <span class="o">=</span> <span class="s1">&#39; on the common subset of vocabularies. &#39;</span>
            <span class="n">commonsub</span> <span class="o">=</span> <span class="s1">&#39;commonsubset&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">caption_suffix</span> <span class="o">=</span> <span class="s1">&#39;. &#39;</span>
            <span class="n">commonsub</span> <span class="o">=</span> <span class="s1">&#39;full&#39;</span>
        <span class="n">print_brain_scores</span><span class="p">(</span><span class="n">brain_scores</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="n">tablefmt</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">score_explanation</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">caption_suffix</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{commonsub}</span><span class="s1">_</span><span class="si">{fname_pad}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;coverage&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">vocabs</span><span class="p">,</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">vecs_names</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--------------&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;--------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">coverage</span><span class="p">(</span><span class="n">vocab</span><span class="p">,</span> <span class="n">datasets</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">savepath</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scores</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">scs</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">savepath</span> <span class="o">+</span> <span class="n">f</span><span class="s1">&#39;_</span><span class="si">{name}</span><span class="s1">.npy&#39;</span><span class="p">,</span> <span class="n">scs</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">savepath</span> <span class="o">+</span> <span class="s1">&#39;_pairs.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">brain_scores</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">savepath</span> <span class="o">+</span> <span class="s1">&#39;_brain.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">brain_scores</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">argh</span><span class="o">.</span><span class="n">dispatch_commands</span><span class="p">([</span><span class="n">main</span><span class="p">,</span> <span class="n">divide_eval_vocab_by_freqranges</span><span class="p">])</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Anita Lilla Verő.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>