<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>source.unsupervised_metrics &mdash; EmbEval 18 October 2021 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> EmbEval
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dependencies.html">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example.html">Example Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">EmbEval Modules Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">EmbEval</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>source.unsupervised_metrics</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for source.unsupervised_metrics</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argh</span>
<span class="kn">from</span> <span class="nn">argh</span> <span class="k">import</span> <span class="n">arg</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="k">import</span> <span class="n">DBSCAN</span><span class="p">,</span> <span class="n">KMeans</span><span class="p">,</span> <span class="n">AgglomerativeClustering</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">metrics</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="k">import</span> <span class="n">cosine_distances</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="k">import</span> <span class="n">cosine</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="k">import</span> <span class="n">wordnet</span> <span class="k">as</span> <span class="n">wn</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="k">import</span> <span class="n">tabulate</span>
<span class="kn">from</span> <span class="nn">pylatexenc.latexencode</span> <span class="k">import</span> <span class="n">unicode_to_latex</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;savefig.dpi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">300</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;fivethirtyeight&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">groupby</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="k">import</span> <span class="n">tabulate</span><span class="p">,</span> <span class="n">LATEX_ESCAPE_RULES</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">source.utils</span> <span class="k">import</span> <span class="n">suffixate</span><span class="p">,</span> <span class="n">tuple_list</span><span class="p">,</span> <span class="n">pfont</span><span class="p">,</span> <span class="n">latex_table_post_process</span><span class="p">,</span> <span class="n">PrintFont</span><span class="p">,</span> <span class="n">LaTeXFont</span>
<span class="kn">from</span> <span class="nn">source.process_embeddings</span> <span class="k">import</span> <span class="n">Embeddings</span><span class="p">,</span> <span class="n">mid_fusion</span><span class="p">,</span> <span class="n">filter_by_vocab</span>


<span class="n">FIG_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s1">&#39;figs&#39;</span><span class="p">)</span>


<span class="c1">################# Nearest Neigbor metrics #################</span>


<div class="viewcode-block" id="get_n_nearest_neighbors"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.get_n_nearest_neighbors">[docs]</a><span class="k">def</span> <span class="nf">get_n_nearest_neighbors</span><span class="p">(</span><span class="n">words</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">E</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">vocab</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;n nearest neighbors for words based on cosine distance in Embedding E.&quot;&quot;&quot;</span>
    <span class="n">w_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">vocab</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">words</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Words indices in Vocab and Embedding E</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">cosine_distances</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">w_C</span> <span class="o">=</span> <span class="n">C</span><span class="p">[:,</span> <span class="n">w_idx</span><span class="p">]</span>  <span class="c1"># Filter columns for words</span>
    <span class="n">nNN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">w_C</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="n">n</span><span class="p">]</span>  <span class="c1"># Every column j contains the indices of NNs of word_j</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">words</span><span class="p">,</span> <span class="n">vocab</span><span class="p">[</span><span class="n">nNN</span><span class="p">]])</span>  <span class="c1"># 1st row: words, rows 1...n: nearest neighbors</span></div>


<div class="viewcode-block" id="n_nearest_neighbors"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.n_nearest_neighbors">[docs]</a><span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="s1">&#39;--words&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">n_nearest_neighbors</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">words</span><span class="o">=</span><span class="p">[],</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;n nearest neighbors for words based on model &lt;vecs_names&gt;.&quot;&quot;&quot;</span>
    <span class="n">embs</span> <span class="o">=</span> <span class="n">Embeddings</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="p">[</span><span class="n">model_name</span><span class="p">])</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">vocab</span> <span class="o">=</span> <span class="n">embs</span><span class="o">.</span><span class="n">embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">embs</span><span class="o">.</span><span class="n">vocabs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">get_n_nearest_neighbors</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">words</span><span class="p">),</span> <span class="n">E</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span></div>


<span class="c1">################# Clusterization metrics #################</span>


<div class="viewcode-block" id="cluster_method_from_filename"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.cluster_method_from_filename">[docs]</a><span class="k">def</span> <span class="nf">cluster_method_from_filename</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;kmeans&#39;</span> <span class="ow">in</span> <span class="n">fn</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;kmeans&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;agglomerative&#39;</span> <span class="ow">in</span> <span class="n">fn</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;agglomerative&#39;</span>
    <span class="k">return</span> <span class="n">method</span></div>


<div class="viewcode-block" id="dbscan_clustering"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.dbscan_clustering">[docs]</a><span class="k">def</span> <span class="nf">dbscan_clustering</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">labels_</span>

    <span class="c1"># Number of clusters in labels, ignoring noise if present.</span>
    <span class="n">n_clusters_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">labels</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">n_noise_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimated number of clusters: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">n_clusters_</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimated number of noise points: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">n_noise_</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">labels</span></div>


<div class="viewcode-block" id="kmeans"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.kmeans">[docs]</a><span class="k">def</span> <span class="nf">kmeans</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">kmeans_model</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">kmeans_model</span><span class="o">.</span><span class="n">labels_</span>
    <span class="n">centroids</span> <span class="o">=</span> <span class="n">kmeans_model</span><span class="o">.</span><span class="n">cluster_centers_</span>
    <span class="k">return</span> <span class="n">labels</span><span class="p">,</span> <span class="n">centroids</span></div>


<div class="viewcode-block" id="agglomerative_clustering"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.agglomerative_clustering">[docs]</a><span class="k">def</span> <span class="nf">agglomerative_clustering</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">):</span>
    <span class="n">clustering</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">linkage</span><span class="o">=</span><span class="n">linkage</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span>
    <span class="k">return</span> <span class="n">labels</span></div>


<div class="viewcode-block" id="cluster_eval"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.cluster_eval">[docs]</a><span class="k">def</span> <span class="nf">cluster_eval</span><span class="p">(</span><span class="n">vectors</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unsupervised clustering metrics.&quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">safe_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">metric</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="n">metrics</span><span class="o">.</span><span class="n">silhouette_score</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">metric</span><span class="p">(</span><span class="n">vectors</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">metric</span><span class="p">(</span><span class="n">vectors</span><span class="p">,</span> <span class="n">labels</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{0}</span><span class="s2">] </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

    <span class="n">safe_metric</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">silhouette_score</span><span class="p">)</span>
    <span class="n">safe_metric</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">calinski_harabaz_score</span><span class="p">)</span>
    <span class="n">safe_metric</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">davies_bouldin_score</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="run_clustering"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.run_clustering">[docs]</a><span class="k">def</span> <span class="nf">run_clustering</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">cluster_method</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                   <span class="n">workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="n">centroids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">cluster_method</span> <span class="o">==</span> <span class="s1">&#39;dbscan&#39;</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">dbscan_clustering</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">workers</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cluster_method</span> <span class="o">==</span> <span class="s1">&#39;kmeans&#39;</span><span class="p">:</span>
        <span class="n">labels</span><span class="p">,</span> <span class="n">centroids</span> <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">workers</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cluster_method</span> <span class="o">==</span> <span class="s1">&#39;agglomerative&#39;</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">agglomerative_clustering</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="n">linkage</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cluster_eval</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">labels</span><span class="p">),</span> <span class="n">labels</span><span class="p">,</span> <span class="n">centroids</span></div>


<div class="viewcode-block" id="get_clustering_labels_metrics"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.get_clustering_labels_metrics">[docs]</a><span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;-vns&#39;</span><span class="p">,</span> <span class="s1">&#39;--vecs_names&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_clustering_labels_metrics</span><span class="p">(</span><span class="n">vecs_names</span><span class="o">=</span><span class="p">[],</span> <span class="n">datadir</span><span class="o">=</span><span class="s1">&#39;/anfs/bigdisc/alv34/wikidump/extracted/models/&#39;</span><span class="p">,</span>
                                  <span class="n">savedir</span><span class="o">=</span><span class="s1">&#39;/anfs/bigdisc/alv34/wikidump/extracted/models/results/&#39;</span><span class="p">,</span>
                                  <span class="n">cluster_method</span><span class="o">=</span><span class="s1">&#39;kmeans&#39;</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                                  <span class="n">workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">):</span>
    <span class="n">embs</span> <span class="o">=</span> <span class="n">Embeddings</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">vecs_names</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">embs</span><span class="o">.</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">embs</span><span class="o">.</span><span class="n">vocabs</span><span class="p">,</span> <span class="n">embs</span><span class="o">.</span><span class="n">vecs_names</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">model_metrics</span><span class="p">,</span> <span class="n">cl_labels</span><span class="p">,</span> <span class="n">centroids</span> <span class="o">=</span> <span class="n">run_clustering</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">cluster_method</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">,</span> <span class="n">random_state</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span>
                                                             <span class="n">min_samples</span><span class="p">,</span> <span class="n">workers</span><span class="p">,</span> <span class="n">linkage</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span>
                               <span class="n">f</span><span class="s1">&#39;cluster_metrics_labelled_</span><span class="si">{cluster_method}</span><span class="s1">_</span><span class="si">{l}</span><span class="s1">_nc</span><span class="si">{n_clusters}</span><span class="s1">{suffixate(suffix)}.json&#39;</span><span class="p">),</span>
                  <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_metrics</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="n">label_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">w</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cl_labels</span><span class="p">,</span> <span class="n">v</span><span class="p">)}</span>
        <span class="n">cluster_label_filepath</span> <span class="o">=</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;cluster_labels_</span><span class="si">{cluster_method}</span><span class="s1">_</span><span class="si">{l}</span><span class="s1">_nc</span><span class="si">{n_clusters}</span><span class="s1">{suffixate(suffix)}.json&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cluster_label_filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">label_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="n">inspect_clusters</span><span class="p">(</span><span class="n">cluster_label_filepath</span><span class="p">)</span>  <span class="c1"># Save printable clusters dict</span>

        <span class="k">if</span> <span class="n">centroids</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="c1"># Save distances from centroids</span>
            <span class="n">dists</span> <span class="o">=</span> <span class="n">distances_from_centroids</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">label_dict</span><span class="p">,</span> <span class="n">centroids</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span>
                                   <span class="n">f</span><span class="s1">&#39;dists_from_centr_</span><span class="si">{cluster_method}</span><span class="s1">_</span><span class="si">{l}</span><span class="s1">_nc</span><span class="si">{n_clusters}</span><span class="s1">{suffixate(suffix)}.json&#39;</span><span class="p">),</span>
                      <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="distances_from_centroids"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.distances_from_centroids">[docs]</a><span class="k">def</span> <span class="nf">distances_from_centroids</span><span class="p">(</span><span class="n">emb</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">label_dict</span><span class="p">,</span> <span class="n">centroids</span><span class="p">):</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">label_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">V</span> <span class="o">==</span> <span class="n">w</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dists</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosine</span><span class="p">(</span><span class="n">emb</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">centroids</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">cl</span><span class="p">),</span> <span class="p">:])</span>
    <span class="k">return</span> <span class="n">dists</span></div>


<div class="viewcode-block" id="order_words_by_centroid_distance"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.order_words_by_centroid_distance">[docs]</a><span class="k">def</span> <span class="nf">order_words_by_centroid_distance</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">cluster_label_filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Order words by their distance from the centroid&quot;&quot;&quot;</span>
    <span class="n">path</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cluster_label_filepath</span><span class="p">)</span>
    <span class="n">dist_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;dists_from_centr&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dist_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">cent_dists</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cl</span><span class="p">,</span> <span class="n">words</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
        <span class="n">words</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">cent_dists</span><span class="p">[</span><span class="n">w</span><span class="p">])</span></div>


<div class="viewcode-block" id="save_closest_words_to_centroids"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.save_closest_words_to_centroids">[docs]</a><span class="k">def</span> <span class="nf">save_closest_words_to_centroids</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Save words from each cluster, which are closest to the centroid.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;cluster_files.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">cf</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">cwords</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">clfile</span> <span class="ow">in</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;clfiles&#39;</span><span class="p">]:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">],</span> <span class="n">clfile</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">words</span> <span class="ow">in</span> <span class="bp">cls</span><span class="p">:</span>
            <span class="n">cwords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">],</span> <span class="s1">&#39;centroid_words.json&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cwords</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="synset_closures"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.synset_closures">[docs]</a><span class="k">def</span> <span class="nf">synset_closures</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">get_names</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">hyper</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">hypernyms</span><span class="p">()</span>
    <span class="n">synsets</span> <span class="o">=</span> <span class="n">wn</span><span class="o">.</span><span class="n">synsets</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="n">closures</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">closure</span><span class="p">(</span><span class="n">hyper</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">))</span> <span class="k">for</span> <span class="n">sns</span> <span class="ow">in</span> <span class="n">synsets</span><span class="p">]))</span> <span class="o">+</span> <span class="n">synsets</span>
    <span class="k">if</span> <span class="n">get_names</span><span class="p">:</span>
        <span class="n">closures</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">syns</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">syns</span> <span class="ow">in</span> <span class="n">closures</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">closures</span></div>


<div class="viewcode-block" id="wn_label_for_words"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.wn_label_for_words">[docs]</a><span class="k">def</span> <span class="nf">wn_label_for_words</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">sys_name_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
        <span class="n">sys_name_list</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">synset_closures</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">get_names</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">sys_name_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">fq</span> <span class="ow">in</span> <span class="n">label</span><span class="o">.</span><span class="n">most_common</span><span class="p">()]</span></div>


<div class="viewcode-block" id="label_clusters_with_wordnet"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.label_clusters_with_wordnet">[docs]</a><span class="k">def</span> <span class="nf">label_clusters_with_wordnet</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_label_num</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;First max_label_num most common synset names.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;cluster_files.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">cf</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">clfile</span> <span class="ow">in</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;clfiles&#39;</span><span class="p">]:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">],</span> <span class="n">clfile</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">wncls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">clid</span><span class="p">,</span> <span class="n">words</span> <span class="ow">in</span> <span class="bp">cls</span><span class="p">:</span>
            <span class="n">wncls</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">clid</span><span class="p">,</span> <span class="n">wn_label_for_words</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">depth</span><span class="p">)[:</span><span class="n">max_label_num</span><span class="p">],</span> <span class="n">words</span><span class="p">))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">],</span> <span class="n">clfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;clusters&#39;</span><span class="p">,</span> <span class="s1">&#39;clusters_WN&#39;</span><span class="p">)),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">wncls</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="inspect_clusters"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.inspect_clusters">[docs]</a><span class="k">def</span> <span class="nf">inspect_clusters</span><span class="p">(</span><span class="n">cluster_label_filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert cluster label file containing {word: label} dict to {cluster_id: wordlist} dict,</span>
<span class="sd">     ordered by the number of cluster members.</span>
<span class="sd">    :param cluster_label_filepath:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cluster_label_filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">cl_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cl_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">clusters</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">cl</span><span class="p">,</span> <span class="n">ws</span><span class="p">)</span> <span class="k">for</span> <span class="n">cl</span><span class="p">,</span> <span class="n">ws</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># Save clusters</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cluster_label_filepath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cluster_labels&#39;</span><span class="p">,</span> <span class="s1">&#39;clusters&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="print_clusters"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.print_clusters">[docs]</a><span class="k">def</span> <span class="nf">print_clusters</span><span class="p">(</span><span class="n">clusters_WN_filepath</span><span class="p">,</span> <span class="n">tablefmt</span><span class="p">,</span> <span class="n">barfontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param clusters_WN_filepath:</span>
<span class="sd">    :param tablefmt: printed table format. &#39;simple&#39; - terminal, &#39;latex_raw&#39; - latex table.</span>
<span class="sd">    :param barfontsize:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Table of cluster members ordered by size</span>
    <span class="n">embtype</span> <span class="o">=</span> <span class="n">emb_labels</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">clusters_WN_filepath</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">method</span> <span class="o">=</span> <span class="n">cluster_method_from_filename</span><span class="p">(</span><span class="n">clusters_WN_filepath</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">clusters_WN_filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">cluster_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;latex&#39;</span> <span class="ow">in</span> <span class="n">tablefmt</span><span class="p">:</span>
        <span class="n">font</span> <span class="o">=</span> <span class="n">LaTeXFont</span>
        <span class="n">labelform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ls</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">makecell[tr]{&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">font</span> <span class="o">=</span> <span class="n">PrintFont</span>
        <span class="n">labelform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">([(</span><span class="n">labelform</span><span class="p">(</span><span class="n">wnls</span><span class="p">),</span> <span class="n">cl</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">))</span> <span class="k">for</span> <span class="n">cl</span><span class="p">,</span> <span class="n">wnls</span><span class="p">,</span> <span class="n">words</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">],</span>
                     <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="n">pfont</span><span class="p">([</span><span class="s1">&#39;BOLD&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;WN label&#39;</span><span class="p">,</span> <span class="s1">&#39;Own label&#39;</span><span class="p">,</span> <span class="s1">&#39;Members&#39;</span><span class="p">]],</span>
                     <span class="n">tablefmt</span><span class="o">=</span><span class="n">tablefmt</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;latex&#39;</span> <span class="ow">in</span> <span class="n">tablefmt</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">latex_table_post_process</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cluster_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                         <span class="n">f</span><span class="s1">&#39;Members of the {len(clusters)} clusters in </span><span class="si">{embtype}</span><span class="s1">. Clusters are ordered by size.&#39;</span><span class="p">,</span>
                                         <span class="n">label</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{embtype}</span><span class="s1">_{len(clusters)}_clusters&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;figs/</span><span class="si">{embtype}</span><span class="s1">_{len(clusters)}_clusters_</span><span class="si">{method}</span><span class="s1">.tex&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="n">avgfreq_file</span> <span class="o">=</span> <span class="n">clusters_WN_filepath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;WN&#39;</span><span class="p">,</span> <span class="s1">&#39;avgfeq&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">avgfreq_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">avgfreq_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">cl_freqs</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cl_freqs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">cluster_sizes_avgfreq</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">cl_freqs</span><span class="p">,</span> <span class="n">embtype</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">barfontsize</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">table</span></div>


<div class="viewcode-block" id="cluster_sizes_avgfreq"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.cluster_sizes_avgfreq">[docs]</a><span class="k">def</span> <span class="nf">cluster_sizes_avgfreq</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">cl_freqs</span><span class="p">,</span> <span class="n">embtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">barfontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Historgram of cluster sizes&quot;&quot;&quot;</span>
    <span class="n">cluster_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#30a2da&#39;</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Clusters&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">barfontsize</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;#Members&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">barfontsize</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">cluster_num</span><span class="p">),</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span> <span class="k">for</span> <span class="n">cl</span><span class="p">,</span> <span class="n">wnls</span><span class="p">,</span> <span class="n">ws</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">xtick_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cluster_num</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">cluster_num</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="n">xtick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_num</span><span class="p">)]</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">cluster_num</span><span class="p">))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xtick_labels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">cl_freqs</span><span class="p">:</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># instantiate a second axes that shares the same x-axis</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#fc4f30&#39;</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Avg word frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">barfontsize</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>  <span class="c1"># we already handled the x-label with ax1</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">mf</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">sf</span> <span class="ow">in</span> <span class="n">cl_freqs</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;figs/</span><span class="si">{embtype}</span><span class="s1">_{len(clusters)}_cluster_hist_</span><span class="si">{method}</span><span class="s1">{suffixate(suffix)}.png&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="jaccard_similarity_score"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.jaccard_similarity_score">[docs]</a><span class="k">def</span> <span class="nf">jaccard_similarity_score</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Jaccard Similarity J (A,B) = | Intersection (A,B) | /</span>
<span class="sd">                                    | Union (A,B) |</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">intersection_cardinality</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
    <span class="n">union_cardinality</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">intersection_cardinality</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">union_cardinality</span><span class="p">)</span></div>


<div class="viewcode-block" id="order_clusters_by_avgfreq"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.order_clusters_by_avgfreq">[docs]</a><span class="k">def</span> <span class="nf">order_clusters_by_avgfreq</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">clfile</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">clfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;WN&#39;</span><span class="p">,</span> <span class="s1">&#39;avgfeq&#39;</span><span class="p">)),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">cl_freqs</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">cl_freqs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cl_freqs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="p">{</span><span class="n">clid</span><span class="p">:</span> <span class="p">[</span><span class="n">wn_label</span><span class="p">,</span> <span class="n">words</span><span class="p">]</span> <span class="k">for</span> <span class="n">clid</span><span class="p">,</span> <span class="n">wn_label</span><span class="p">,</span> <span class="n">words</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">}</span>
    <span class="n">ordered_cls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">clid</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">fq_mean</span><span class="p">,</span> <span class="n">fq_std</span> <span class="ow">in</span> <span class="n">cl_freqs</span><span class="p">:</span>
        <span class="n">ordered_cls</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">clid</span><span class="p">]</span> <span class="o">+</span> <span class="n">clusters</span><span class="p">[</span><span class="n">clid</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">fq_mean</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">ordered_cls</span></div>


<div class="viewcode-block" id="cluster_similarities"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.cluster_similarities">[docs]</a><span class="k">def</span> <span class="nf">cluster_similarities</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">clmethod</span><span class="o">=</span><span class="s1">&#39;agglomerative&#39;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">datapath</span> <span class="o">=</span> <span class="s1">&#39;/Users/anitavero/projects/data/wikidump/models/results&#39;</span>
    <span class="n">emb_clusters1</span><span class="p">,</span> <span class="n">emb_clusters2</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">read_clusters</span><span class="p">(</span><span class="n">clmethod</span><span class="p">):</span>
        <span class="n">emb_clusters</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">clfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;clusters_WN_</span><span class="si">{clmethod}</span><span class="s1">_vecs3lem1_common_subset_nc20.json&#39;</span><span class="p">,</span>
                   <span class="n">f</span><span class="s1">&#39;clusters_WN_</span><span class="si">{clmethod}</span><span class="s1">_model_n-1_s0_window-5_common_subset_nc20.json&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">order</span> <span class="o">!=</span> <span class="s1">&#39;avgfreq&#39;</span><span class="p">:</span>
            <span class="n">clfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;clusters_WN_</span><span class="si">{clmethod}</span><span class="s1">_google_resnet152_common_subset_nc20.json&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">clfile</span> <span class="ow">in</span> <span class="n">clfiles</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">clfile</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">clusters</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">embtype</span> <span class="o">=</span> <span class="n">emb_labels</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">clfile</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">emb_clusters</span><span class="p">[</span><span class="n">embtype</span><span class="p">]</span> <span class="o">=</span> <span class="n">clusters</span>
            <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;avgfreq&#39;</span><span class="p">:</span>
                <span class="n">emb_clusters</span><span class="p">[</span><span class="n">embtype</span><span class="p">]</span> <span class="o">=</span> <span class="n">order_clusters_by_avgfreq</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">clfile</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">emb_clusters</span>

    <span class="k">if</span> <span class="n">clmethod</span> <span class="o">==</span> <span class="s1">&#39;kmeans&#39;</span> <span class="ow">or</span> <span class="n">clmethod</span> <span class="o">==</span> <span class="s1">&#39;agglomerative&#39;</span><span class="p">:</span>
        <span class="n">emb_clusters</span> <span class="o">=</span> <span class="n">read_clusters</span><span class="p">(</span><span class="n">clmethod</span><span class="p">)</span>
        <span class="n">emb_clusters1</span><span class="p">,</span> <span class="n">emb_clusters2</span> <span class="o">=</span> <span class="n">emb_clusters</span><span class="p">,</span> <span class="n">emb_clusters</span>
        <span class="n">compare</span> <span class="o">=</span> <span class="s1">&#39;cross&#39;</span>
    <span class="k">elif</span> <span class="n">clmethod</span> <span class="o">==</span> <span class="s1">&#39;kmeans_agglomerative&#39;</span><span class="p">:</span>
        <span class="n">emb_clusters1</span> <span class="o">=</span> <span class="n">read_clusters</span><span class="p">(</span><span class="s1">&#39;kmeans&#39;</span><span class="p">)</span>
        <span class="n">emb_clusters2</span> <span class="o">=</span> <span class="n">read_clusters</span><span class="p">(</span><span class="s1">&#39;agglomerative&#39;</span><span class="p">)</span>
        <span class="n">compare</span> <span class="o">=</span> <span class="s1">&#39;dot&#39;</span>

    <span class="k">return</span> <span class="n">compute_cluster_similarities</span><span class="p">(</span><span class="n">emb_clusters1</span><span class="p">,</span> <span class="n">emb_clusters2</span><span class="p">,</span> <span class="n">compare</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">clmethod</span><span class="p">,</span> <span class="n">plot</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_cluster_similarities"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.compute_cluster_similarities">[docs]</a><span class="k">def</span> <span class="nf">compute_cluster_similarities</span><span class="p">(</span><span class="n">emb_clusters1</span><span class="p">,</span> <span class="n">emb_clusters2</span><span class="p">,</span> <span class="n">compare</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">clmethod</span><span class="p">,</span> <span class="n">plot</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param emb_clusters1:</span>
<span class="sd">    :param emb_clusters2:</span>
<span class="sd">    :param compare: &#39;cross&#39; or &#39;dot&#39;</span>
<span class="sd">    :param order:</span>
<span class="sd">    :param clmethod:</span>
<span class="sd">    :param plot:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">compute_sim</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">cls1</span><span class="p">):</span>
        <span class="n">sims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
        <span class="n">xticks</span><span class="p">,</span> <span class="n">yticks</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
            <span class="n">yticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">f</span><span class="s1">&#39; {round(c[3], 5)}&#39;</span> <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;avgfreq&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cls1</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
                    <span class="n">xticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">f</span><span class="s1">&#39; {round(c1[3], 5)}&#39;</span> <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;avgfreq&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="n">sims</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">jaccard_similarity_score</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">c1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">jaccard_similarities</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{e}</span><span class="s1">-</span><span class="si">{e1}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sims</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;clustermap&#39;</span><span class="p">:</span>
                <span class="n">similarity_clustermap</span><span class="p">(</span><span class="n">sims</span><span class="p">,</span> <span class="n">xticks</span><span class="p">,</span> <span class="n">yticks</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{e}</span><span class="s1">-</span><span class="si">{e1}</span><span class="s1">_</span><span class="si">{clmethod}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span> <span class="ow">or</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;avgfreq&#39;</span><span class="p">:</span>
                <span class="n">similarity_heatmap</span><span class="p">(</span><span class="n">sims</span><span class="p">,</span> <span class="n">xticks</span><span class="p">,</span> <span class="n">yticks</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{e}</span><span class="s1">-</span><span class="si">{e1}</span><span class="s1">_</span><span class="si">{clmethod}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="n">jaccard_similarities</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">compare</span> <span class="o">==</span> <span class="s1">&#39;cross&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ie</span><span class="p">,</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">emb_clusters1</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">ie1</span><span class="p">,</span> <span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">cls1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">emb_clusters2</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">ie</span> <span class="o">&lt;</span> <span class="n">ie1</span><span class="p">:</span>
                    <span class="n">compute_sim</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">cls1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">compare</span> <span class="o">==</span> <span class="s1">&#39;dot&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">cls</span><span class="p">),</span> <span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">cls1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">emb_clusters1</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">emb_clusters2</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">compute_sim</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">cls1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jaccard_similarities</span></div>


<div class="viewcode-block" id="similar_cluster_nums"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.similar_cluster_nums">[docs]</a><span class="k">def</span> <span class="nf">similar_cluster_nums</span><span class="p">(</span><span class="n">clmethod</span><span class="o">=</span><span class="s1">&#39;agglomerative&#39;</span><span class="p">):</span>
    <span class="n">jss</span> <span class="o">=</span> <span class="n">cluster_similarities</span><span class="p">(</span><span class="n">clmethod</span><span class="o">=</span><span class="n">clmethod</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">thresholds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]</span>
    <span class="n">nums</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">maxs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">jss</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
            <span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">jss</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">th</span><span class="p">))</span>
        <span class="n">maxs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">jss</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">nums</span><span class="p">,</span> <span class="n">maxs</span></div>


<div class="viewcode-block" id="similarity_clustermap"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.similarity_clustermap">[docs]</a><span class="k">def</span> <span class="nf">similarity_clustermap</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">xticks</span><span class="p">,</span> <span class="n">yticks</span><span class="p">,</span> <span class="n">title_embs</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">yticks</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">clustermap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># plt.setp(cm.ax_heatmap.xaxis.get_majorticklabels(), rotation=45)  # Messes up the labels...</span>
    <span class="n">cm</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Jaccard similarities of clusters in </span><span class="si">{title_embs}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">cm</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;figs/</span><span class="si">{title_embs}</span><span class="s1">_jaccard_clustermap.png&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="similarity_heatmap"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.similarity_heatmap">[docs]</a><span class="k">def</span> <span class="nf">similarity_heatmap</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">xticks</span><span class="p">,</span> <span class="n">yticks</span><span class="p">,</span> <span class="n">title_embs</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># We want to show all ticks...</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xticks</span><span class="p">)))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yticks</span><span class="p">)))</span>
    <span class="c1"># ... and label them with the respective list entries</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">yticks</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="c1"># Rotate the tick labels and set their alignment.</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
             <span class="n">rotation_mode</span><span class="o">=</span><span class="s2">&quot;anchor&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
             <span class="n">rotation_mode</span><span class="o">=</span><span class="s2">&quot;anchor&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Jaccard similarities of clusters in </span><span class="si">{title_embs}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;figs/</span><span class="si">{title_embs}</span><span class="s1">_jaccard_heatmap_</span><span class="si">{order}</span><span class="s1">.png&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="run_print_clusters"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.run_print_clusters">[docs]</a><span class="k">def</span> <span class="nf">run_print_clusters</span><span class="p">(</span><span class="n">barfontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;cluster_files.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">cf</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">clfile</span> <span class="ow">in</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;clfiles&#39;</span><span class="p">]:</span>
        <span class="n">print_clusters</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">],</span> <span class="n">clfile</span><span class="p">),</span> <span class="s1">&#39;latex_raw&#39;</span><span class="p">,</span> <span class="n">barfontsize</span><span class="o">=</span><span class="n">barfontsize</span><span class="p">)</span></div>


<div class="viewcode-block" id="run_inspect_clusters"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.run_inspect_clusters">[docs]</a><span class="k">def</span> <span class="nf">run_inspect_clusters</span><span class="p">():</span>
    <span class="n">datapath</span> <span class="o">=</span> <span class="s1">&#39;/Users/anitavero/projects/data/wikidump/models/results&#39;</span>
    <span class="k">for</span> <span class="n">clfile</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cluster_labels_kmeans_vecs3lem1_common_subset_nc20.json&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;cluster_labels_kmeans_vecs3lem1_common_subset_nc40.json&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;cluster_labels_kmeans_model_n-1_s0_window-5_common_subset_nc20.json&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;cluster_labels_kmeans_google_resnet152_common_subset_nc20.json&#39;</span><span class="p">]:</span>
        <span class="n">inspect_clusters</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">clfile</span><span class="p">))</span></div>


<div class="viewcode-block" id="avg_cluster_wordfrequency"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.avg_cluster_wordfrequency">[docs]</a><span class="k">def</span> <span class="nf">avg_cluster_wordfrequency</span><span class="p">(</span><span class="n">datadir</span><span class="o">=</span><span class="s1">&#39;/Users/anitavero/projects/data/&#39;</span><span class="p">,</span> <span class="n">clmethod</span><span class="o">=</span><span class="s1">&#39;agglomerative&#39;</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;wikidump/tokenized/common_subset_vocab_VG_GoogleResnet_Wiki2020.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">vocab</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;wikidump/tokenized/distribution.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">wiki_dist</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">wiki_dist_com</span> <span class="o">=</span> <span class="p">{</span><span class="n">w</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">wiki_dist</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Wiki&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">vocab</span><span class="p">}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;visualgenome/vg_contexts_rad3_lemmatised1_dists.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">vg_dist</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">vg_dist_com</span> <span class="o">=</span> <span class="p">{</span><span class="n">w</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">vg_dist</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;VG rel&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">vocab</span><span class="p">}</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">wiki_dist_com</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">vg_dist_com</span><span class="p">)</span>

    <span class="c1"># Relative frequencies</span>
    <span class="n">sum_wiki</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">wiki_dist_com</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">wiki_dist_com</span> <span class="o">=</span> <span class="p">{</span><span class="n">w</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="n">sum_wiki</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">wiki_dist_com</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">wiki_dist_com</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">wiki_dist_com</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])}</span>

    <span class="n">sum_vg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vg_dist_com</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">vg_dist_com</span> <span class="o">=</span> <span class="p">{</span><span class="n">w</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="n">sum_vg</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">vg_dist_com</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">vg_dist_com</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vg_dist_com</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])}</span>

    <span class="n">freqs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wiki&#39;</span><span class="p">:</span> <span class="n">wiki_dist_com</span><span class="p">,</span> <span class="s1">&#39;vg&#39;</span><span class="p">:</span> <span class="n">vg_dist_com</span><span class="p">}</span>

    <span class="c1"># Avg rel freqs for clusters</span>
    <span class="n">datapath</span> <span class="o">=</span> <span class="s1">&#39;/Users/anitavero/projects/data/wikidump/models/results&#39;</span>
    <span class="k">for</span> <span class="n">clfile</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">f</span><span class="s1">&#39;clusters_</span><span class="si">{clmethod}</span><span class="s1">_vecs3lem1_common_subset_nc20.json&#39;</span><span class="p">,</span> <span class="s1">&#39;vg&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">f</span><span class="s1">&#39;clusters_</span><span class="si">{clmethod}</span><span class="s1">_model_n-1_s0_window-5_common_subset_nc20.json&#39;</span><span class="p">,</span> <span class="s1">&#39;wiki&#39;</span><span class="p">)]:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">clfile</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">fqcls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">clid</span><span class="p">,</span> <span class="n">words</span> <span class="ow">in</span> <span class="bp">cls</span><span class="p">:</span>
            <span class="n">cl_freqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">freqs</span><span class="p">[</span><span class="n">mod</span><span class="p">][</span><span class="n">w</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span>
            <span class="n">fqcls</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">clid</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cl_freqs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cl_freqs</span><span class="p">)))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">clfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;clusters&#39;</span><span class="p">,</span> <span class="s1">&#39;clusters_avgfeq&#39;</span><span class="p">)),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">fqcls</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<span class="c1"># def vg_dists(datadir=&#39;/Users/anitavero/projects/data/visualgenome&#39;):</span>
<span class="c1">#     with open(os.path.join(datadir, &#39;vg_contexts_rad3_lemmatised1.txt&#39;), &#39;r&#39;) as f:</span>
<span class="c1">#         ctx = [pair.split() for pair in tqdm(f.read().split(&#39;\n&#39;))]</span>
<span class="c1">#     words = []</span>
<span class="c1">#     for pair in ctx:</span>
<span class="c1">#         if len(pair) &lt; 2:</span>
<span class="c1">#             print(&#39;MISSING&#39;, pair)</span>
<span class="c1">#         else:</span>
<span class="c1">#             words.append(pair[0])</span>
<span class="c1">#     with open(os.path.join(datadir, &#39;vg_contexts_rad3_lemmatised1_dists.json&#39;), &#39;w&#39;) as f:</span>
<span class="c1">#         json.dump(Counter(words), f)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># def vg_pmis(words_file, datadir=&#39;/Users/anitavero/projects/data/visualgenome&#39;):</span>
<span class="c1">#     &quot;&quot;&quot;Save PMI scores for bigrams including words in file word_list.</span>
<span class="c1">#         :param words_file: json file name in data_dir, consisting of an str list</span>
<span class="c1">#         :param datadir: path to directory with data</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     with open(os.path.join(datadir, words_file), &#39;r&#39;) as f:</span>
<span class="c1">#         words = json.load(f)</span>
<span class="c1">#     with open(os.path.join(datadir, &#39;vg_contexts_rad3_lemmatised1.txt&#39;), &#39;r&#39;) as f:</span>
<span class="c1">#         ctx = [pair.split() for pair in tqdm(f.read().split(&#39;\n&#39;), desc=&#39;Read VG contexts&#39;)]</span>
<span class="c1">#     pmis = pmi_for_words(words, document_list=ctx)</span>
<span class="c1">#     print(&quot;Save PMIs&quot;)</span>
<span class="c1">#     with open(os.path.join(datadir, words_file.replace(&#39;.&#39;, &#39;_VG_pmi.&#39;)), &#39;w&#39;) as f:</span>
<span class="c1">#         json.dump(pmis, f)</span>


<div class="viewcode-block" id="pmi_comparison"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.pmi_comparison">[docs]</a><span class="k">def</span> <span class="nf">pmi_comparison</span><span class="p">(</span><span class="n">datadir</span><span class="o">=</span><span class="s1">&#39;/Users/anitavero/projects/data/wikidump/models/results/&#39;</span><span class="p">,</span> <span class="n">pmi_th</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">variants</span><span class="o">=</span><span class="s1">&#39;ppmi&#39;</span><span class="p">,</span>
                   <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;latex&#39;</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;centroid_words_WIKI_</span><span class="si">{variants}</span><span class="s1">.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">wiki_pmis</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;centroid_words_VG_</span><span class="si">{variants}</span><span class="s1">.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">vg_pmis</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">not_w</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">w</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">pmis_print</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">pmis</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;{not_w(ws, w)}: {round(pmi, 3)}&#39;</span> <span class="k">for</span> <span class="n">ws</span><span class="p">,</span> <span class="n">pmi</span> <span class="ow">in</span> <span class="n">pmis</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">pmis_latex</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">pmis</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">not_w</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">ws</span><span class="p">,</span> <span class="n">pmi</span> <span class="ow">in</span> <span class="n">pmis</span><span class="p">)</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">unique_ctx</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">ctx</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">w</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">or</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">))]</span>
        <span class="k">return</span> <span class="n">unicode_to_latex</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique_ctx</span><span class="p">))</span>


    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">wiki_pmis</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;latex&#39;</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">w</span><span class="p">,</span> <span class="n">pmis_latex</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">wiki_pmis</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">w</span><span class="p">][:</span><span class="n">pmi_th</span><span class="p">]),</span>
                           <span class="n">pmis_latex</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">vg_pmis</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">w</span><span class="p">][:</span><span class="n">pmi_th</span><span class="p">])</span>
                            <span class="p">))</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="n">pfont</span><span class="p">([</span><span class="s1">&#39;BOLD&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">LaTeXFont</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Centroid&#39;</span><span class="p">,</span> <span class="s1">&#39;Wikipedia&#39;</span><span class="p">,</span> <span class="s1">&#39;VG&#39;</span><span class="p">]],</span>
                             <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;latex_raw&#39;</span><span class="p">)</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">latex_table_post_process</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                             <span class="n">f</span><span class="s1">&#39;Context words of cluster centroids with the </span><span class="si">{pmi_th}</span><span class="s1"> highest </span><span class="si">{var}</span><span class="s1"> score.&#39;</span><span class="p">,</span>
                                             <span class="n">label</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;wiki_vg_highest_</span><span class="si">{pmi_th}</span><span class="s1">_</span><span class="si">{var}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;wiki_vg_highest_</span><span class="si">{pmi_th}</span><span class="s1">_</span><span class="si">{var}</span><span class="s1">.tex&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">z</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pmis_print</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">wiki_pmis</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">w</span><span class="p">][:</span><span class="n">pmi_th</span><span class="p">]),</span> <span class="n">pmis_print</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">vg_pmis</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">w</span><span class="p">][:</span><span class="n">pmi_th</span><span class="p">]))</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">w</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">z</span><span class="p">))))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;wiki_vg_highest_</span><span class="si">{pmi_th}</span><span class="s1">_</span><span class="si">{var}</span><span class="s1">.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>


<div class="viewcode-block" id="run_clustering_experiments"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.run_clustering_experiments">[docs]</a><span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;-mmembs&#39;</span><span class="p">,</span> <span class="s1">&#39;--mm_embs_of&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">tuple_list</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;-vns&#39;</span><span class="p">,</span> <span class="s1">&#39;--vecs_names&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">run_clustering_experiments</span><span class="p">(</span><span class="n">datadir</span><span class="o">=</span><span class="s1">&#39;/anfs/bigdisc/alv34/wikidump/extracted/models/&#39;</span><span class="p">,</span>
                               <span class="n">savedir</span><span class="o">=</span><span class="s1">&#39;/anfs/bigdisc/alv34/wikidump/extracted/models/results/&#39;</span><span class="p">,</span>
                               <span class="n">vecs_names</span><span class="o">=</span><span class="p">[],</span> <span class="n">mm_embs_of</span><span class="o">=</span><span class="p">[],</span> <span class="n">cluster_method</span><span class="o">=</span><span class="s1">&#39;dbscan&#39;</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">eps</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">):</span>
    <span class="c1"># TODO: Test</span>
    <span class="n">embs</span> <span class="o">=</span> <span class="n">Embeddings</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">vecs_names</span><span class="p">)</span>
    <span class="n">emb_tuples</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">embs</span><span class="o">.</span><span class="n">embeddings</span><span class="p">[</span><span class="n">vecs_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mm_embs_of</span><span class="p">]</span>
    <span class="n">vocab_tuples</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">embs</span><span class="o">.</span><span class="n">vocabs</span><span class="p">[</span><span class="n">vecs_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mm_embs_of</span><span class="p">]</span>
    <span class="n">mm_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mm_embs_of</span><span class="p">]</span>
    <span class="n">mm_embeddings</span><span class="p">,</span> <span class="n">mm_vocabs</span><span class="p">,</span> <span class="n">mm_labels</span> <span class="o">=</span> <span class="n">mid_fusion</span><span class="p">(</span><span class="n">emb_tuples</span><span class="p">,</span> <span class="n">vocab_tuples</span><span class="p">,</span> <span class="n">mm_labels</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Filter all with intersection fo vocabs</span>
    <span class="n">isec_vocab</span> <span class="o">=</span> <span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">mm_vocabs</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="s1">&#39;common_subset_vocab_VG_GoogleResnet_Wiki2020.json&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">isec_vocab</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#Common subset vocab:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">isec_vocab</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">embs</span><span class="o">.</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">embs</span><span class="o">.</span><span class="n">vocabs</span><span class="p">,</span> <span class="n">embs</span><span class="o">.</span><span class="n">vecs_names</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">mm_embeddings</span><span class="p">,</span> <span class="n">mm_vocabs</span><span class="p">,</span> <span class="n">mm_labels</span><span class="p">)):</span>
        <span class="n">fe</span><span class="p">,</span> <span class="n">fv</span> <span class="o">=</span> <span class="n">filter_by_vocab</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">isec_vocab</span><span class="p">)</span>
        <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{l}</span><span class="s1">_common_subset&#39;</span><span class="p">),</span> <span class="n">fe</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{l}</span><span class="s1">_common_subset.vocab&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fv</span><span class="p">))</span>
    <span class="c1"># Add random embedding baseline</span>
    <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">isec_vocab</span><span class="p">),</span> <span class="mi">300</span><span class="p">)))</span>
    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Random&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">nc</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="n">model_metrics</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">run_clustering</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">cluster_method</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">random_state</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">min_samples</span><span class="p">,</span> <span class="n">workers</span><span class="p">,</span>
                                                 <span class="n">linkage</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;cluster_metrics_</span><span class="si">{cluster_method}</span><span class="s1">_</span><span class="si">{l}</span><span class="s1">_nc</span><span class="si">{nc}</span><span class="s1">{suffixate(suffix)}.json&#39;</span><span class="p">),</span>
                      <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_metrics</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_clusters</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">ncs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">10</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">ncs</span><span class="p">):</span>
            <span class="n">run</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n_clusters</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">run</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">)</span></div>


<div class="viewcode-block" id="emb_labels"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.emb_labels">[docs]</a><span class="k">def</span> <span class="nf">emb_labels</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">fn</span> <span class="ow">and</span> <span class="s1">&#39;resnet&#39;</span> <span class="ow">in</span> <span class="n">fn</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;$E_L + E_V$&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">fn</span> <span class="ow">and</span> <span class="s1">&#39;vecs3lem&#39;</span> <span class="ow">in</span> <span class="n">fn</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;$E_L + E_S$&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;resnet&#39;</span> <span class="ow">in</span> <span class="n">fn</span> <span class="ow">and</span> <span class="s1">&#39;model&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fn</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;$E_V$&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;vecs3lem&#39;</span> <span class="ow">in</span> <span class="n">fn</span> <span class="ow">and</span> <span class="s1">&#39;model&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fn</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;$E_S$&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">fn</span> <span class="ow">and</span> <span class="s1">&#39;resnet&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fn</span> <span class="ow">and</span> <span class="s1">&#39;vecs3lem&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fn</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;$E_L$&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;Random&#39;</span> <span class="ow">in</span> <span class="n">fn</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Rand&#39;</span></div>


<div class="viewcode-block" id="print_cluster_results"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.print_cluster_results">[docs]</a><span class="k">def</span> <span class="nf">print_cluster_results</span><span class="p">(</span><span class="n">resdir</span><span class="o">=</span><span class="s1">&#39;/Users/anitavero/projects/data/wikidump/models/&#39;</span><span class="p">):</span>
    <span class="n">res_files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">resdir</span> <span class="o">+</span> <span class="s1">&#39;/cluster_metrics*&#39;</span><span class="p">)</span>
    <span class="n">tab</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Metric&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">rf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res_files</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">emb_labels</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rf</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tab</span><span class="o">.</span><span class="n">append</span><span class="p">([[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res_files</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
            <span class="n">tab</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>
            <span class="n">tab</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_cluster_results"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.plot_cluster_results">[docs]</a><span class="k">def</span> <span class="nf">plot_cluster_results</span><span class="p">(</span><span class="n">resdir</span><span class="o">=</span><span class="s1">&#39;/Users/anitavero/projects/data/wikidump/models/&#39;</span><span class="p">):</span>
    <span class="n">res_files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">resdir</span> <span class="o">+</span> <span class="s1">&#39;/cluster_metrics*&#39;</span><span class="p">)</span>
    <span class="n">grp_files</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">(</span><span class="n">res_files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;kmeans&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;nc&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">score_lines</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
    <span class="n">ncls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ncb</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">get_num_clusters</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;nc&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grp_files</span><span class="p">:</span>
        <span class="n">nc_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">get_num_clusters</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">nc_sorted</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ncb</span><span class="p">:</span>
                <span class="n">ncls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_num_clusters</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">emb_labels</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">score_lines</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
        <span class="n">ncb</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">lines</span> <span class="ow">in</span> <span class="n">score_lines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lb</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ncls</span><span class="p">)))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ncls</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Number of clusters&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">columnspacing</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FIG_DIR</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;{metric.replace(&quot; &quot;, &quot;_&quot;)}_visible&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="wn_category"><a class="viewcode-back" href="../../source.html#source.unsupervised_metrics.wn_category">[docs]</a><span class="k">def</span> <span class="nf">wn_category</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Map a word to categories based on WordNet closures.&quot;&quot;&quot;</span>
    <span class="n">cats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">,</span> <span class="s1">&#39;food&#39;</span><span class="p">,</span> <span class="s1">&#39;building&#39;</span><span class="p">,</span> <span class="s1">&#39;animal&#39;</span><span class="p">,</span> <span class="s1">&#39;appliance&#39;</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="s1">&#39;clothes&#39;</span><span class="p">,</span> <span class="s1">&#39;utensil&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span>
            <span class="s1">&#39;electronics&#39;</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;human&#39;</span><span class="p">]</span>
    <span class="n">cat_synsets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cats</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">wn</span><span class="o">.</span><span class="n">synsets</span><span class="p">,</span> <span class="n">cats</span><span class="p">)))</span>
    <span class="n">hyper</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">hypernyms</span><span class="p">()</span>
    <span class="n">synsets</span> <span class="o">=</span> <span class="n">wn</span><span class="o">.</span><span class="n">synsets</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="n">closures</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">closure</span><span class="p">(</span><span class="n">hyper</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span> <span class="k">for</span> <span class="n">sns</span> <span class="ow">in</span> <span class="n">synsets</span><span class="p">]))</span> <span class="o">+</span> <span class="n">synsets</span>
    <span class="n">max_overlap</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">category</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">cat</span><span class="p">,</span> <span class="n">csns</span> <span class="ow">in</span> <span class="n">cat_synsets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">closures</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">csns</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="n">max_overlap</span><span class="p">:</span>
            <span class="n">category</span> <span class="o">=</span> <span class="n">cat</span>
    <span class="k">return</span> <span class="n">category</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">argh</span><span class="o">.</span><span class="n">dispatch_commands</span><span class="p">([</span><span class="n">run_clustering</span><span class="p">,</span> <span class="n">run_clustering_experiments</span><span class="p">,</span> <span class="n">print_cluster_results</span><span class="p">,</span> <span class="n">plot_cluster_results</span><span class="p">,</span>
                            <span class="n">n_nearest_neighbors</span><span class="p">,</span> <span class="n">get_clustering_labels_metrics</span><span class="p">,</span> <span class="n">inspect_clusters</span><span class="p">,</span> <span class="n">run_inspect_clusters</span><span class="p">,</span>
                            <span class="n">label_clusters_with_wordnet</span><span class="p">,</span> <span class="n">run_print_clusters</span><span class="p">,</span> <span class="n">cluster_similarities</span><span class="p">,</span>
                            <span class="n">avg_cluster_wordfrequency</span><span class="p">,</span> <span class="n">similar_cluster_nums</span><span class="p">,</span> <span class="n">save_closest_words_to_centroids</span><span class="p">,</span>
                            <span class="n">pmi_comparison</span><span class="p">])</span>
    <span class="c1"># vocab = np.array([&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;])</span>
    <span class="c1"># words = np.array([&#39;a&#39;, &#39;c&#39;, &#39;e&#39;])</span>
    <span class="c1"># E = np.array([[1, 0],</span>
    <span class="c1">#               [0, 1],</span>
    <span class="c1">#               [1, 1],</span>
    <span class="c1">#               [1, 0.5],</span>
    <span class="c1">#               [0.5, 1]])</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1"># NN = get_n_nearest_neighbors(words, E, vocab, n=1)</span>
    <span class="c1"># assert (NN[0, :] == words).all()</span>
    <span class="c1"># assert (NN[1:, 0] == np.array([&#39;d&#39;])).all()</span>
    <span class="c1"># assert (NN[1:, 1] == np.array([&#39;d&#39;])).all()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Anita Lilla Verő.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>